<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BINGO MYSTERY AI - Chain Clear Edition</title>
    <style>
        :root { --bg: #0f172a; --glass: rgba(255, 255, 255, 0.1); }
        .col-red { --theme: #ff4d4d; } .col-blue { --theme: #4d94ff; } .col-green { --theme: #2ecc71; } .col-yellow { --theme: #f1c40f; }

        body { font-family: sans-serif; background: var(--bg); color: white; margin: 0; padding: 10px; display: flex; flex-direction: column; align-items: center; min-height: 100vh; overflow-x: hidden; }
        
        .setup-section { width: 95%; max-width: 400px; background: var(--glass); padding: 10px; border-radius: 12px; margin-bottom: 10px; border: 1px dashed #4facfe; box-sizing: border-box; }
        .setup-section input { width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #334155; background: #000; color: #fff; box-sizing: border-box; }

        .item-inventory { width: 95%; max-width: 400px; display: flex; justify-content: space-between; align-items: center; background: rgba(255,255,255,0.05); padding: 10px 15px; border-radius: 15px; margin-bottom: 15px; border: 1px solid gold; box-sizing: border-box; }
        .item-btn { background: linear-gradient(135deg, gold, #f39c12); color: black; border: none; padding: 8px 15px; border-radius: 20px; font-weight: bold; cursor: pointer; font-size: 0.8rem; }

        .bingo-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; width: 100%; max-width: 400px; margin-bottom: 20px; }
        .cell { 
            aspect-ratio: 1/1; background: var(--glass); border: 2px solid var(--theme); border-radius: 10px; 
            display: flex; flex-direction: column; justify-content: center; align-items: center; 
            font-size: 0.6rem; font-weight: bold; text-align: center; cursor: pointer; padding: 5px; box-sizing: border-box; color: var(--theme);
        }
        /* é–‹æ”¾çŠ¶æ…‹ï¼šæ ãŒå…‰ã‚‹ */
        .cell.identified { background: rgba(255, 255, 255, 0.05); box-shadow: inset 0 0 10px var(--theme); color: #fff; } 
        /* ç©ºã„ãŸçŠ¶æ…‹ï¼šå¡—ã‚Šã¤ã¶ã— */
        .cell.complete { background: var(--theme); color: #000; border: none; box-shadow: 0 0 15px var(--theme); }
        .ans-label { font-size: 0.5rem; margin-top: 4px; border-top: 1px solid rgba(0,0,0,0.2); width: 100%; padding-top: 2px; }

        /* å…¨ã‚¯ãƒªã‚¢ç”»é¢ */
        #game-clear-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(to bottom, #1e293b, #0f172a); z-index: 2000; flex-direction: column; justify-content: center; align-items: center; text-align: center; }
        .clear-text { font-size: 3rem; font-weight: bold; color: gold; text-shadow: 0 0 20px white; margin-bottom: 20px; }

        #modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 100; padding: 20px; box-sizing: border-box; overflow-y: auto; }
        .modal-content { max-width: 400px; margin: 0 auto; }
        .input-group { background: rgba(255,255,255,0.05); padding: 15px; border-radius: 15px; margin-bottom: 15px; border: 1px solid rgba(255,255,255,0.1); }
        #view-container { width: 100%; aspect-ratio: 1/1; background: #000; border-radius: 12px; overflow: hidden; margin: 10px 0; border: 2px solid #334155; position: relative; }
        video, canvas { width: 100%; height: 100%; object-fit: cover; position: absolute; top: 0; left: 0; }
        
        button { border: none; border-radius: 10px; padding: 14px; font-weight: bold; cursor: pointer; width: 100%; font-size: 1rem; margin-top: 10px; }
        .btn-solve { background: #fbbf24; color: #000; }
        .select-box { width: 100%; padding: 12px; border-radius: 8px; background: #1e293b; color: white; border: 1px solid #475569; margin-top: 10px; font-size: 1rem; }
    </style>
</head>
<body>

    <h2 style="margin: 10px 0;">BINGO MYSTERY AI</h2>

    <div class="setup-section">
        <input type="password" id="test-api-key" placeholder="Gemini APIã‚­ãƒ¼ã‚’å…¥åŠ›">
    </div>

    <div class="item-inventory">
        <div>
            <span style="font-size: 0.7rem; color: gold; display: block;">ITEM: ãƒã‚¹ã‚¿ãƒ¼ã‚­ãƒ¼(é–‹æ”¾ç”¨)</span>
            <span id="item-count" style="font-size: 1.2rem; font-weight: bold;">0</span>
        </div>
        <button id="use-item-btn" class="item-btn" onclick="toggleItemMode()">ã‚¢ã‚¤ãƒ†ãƒ ã‚’ä½¿ã†</button>
    </div>

    <div class="bingo-grid" id="bingo-board"></div>

    <div class="footer-area">
        <button class="reset-btn" style="background:#444; color:#888; padding:8px; border-radius:5px;" onclick="resetGame()">é€²æ—ãƒªã‚»ãƒƒãƒˆ</button>
    </div>

    <div id="game-clear-overlay">
        <div class="clear-text">GAME CLEAR!</div>
        <p style="color:white;">å…¨ã¦ã®ãƒã‚¹ãŒç©ºãã¾ã—ãŸï¼</p>
        <button class="btn-solve" style="width:200px;" onclick="location.reload()">ã‚‚ã†ä¸€åº¦éŠã¶</button>
    </div>

    <div id="bingo-overlay" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:1000; flex-direction:column; justify-content:center; align-items:center;">
        <div style="font-size:5rem; font-weight:bold; color:gold;">BINGO!</div>
    </div>

    <div id="modal">
        <div class="modal-content">
            <h2 id="modal-title" style="color:#4facfe; margin:0 0 10px 0;">TARGET</h2>
            
            <div id="capture-section">
                <div id="view-container">
                    <video id="video" autoplay playsinline></video>
                    <canvas id="canvas"></canvas>
                </div>
                <button class="btn-capture" style="background:#4facfe; color:white;" onclick="analyzeSpot()">ğŸ“¸ æ’®å½±ã—ã¦ã€Œé–‹æ”¾ã€ã™ã‚‹</button>
                <div id="ai-status" style="font-size:0.75rem; text-align:center; margin-top:8px; color:#94a3b8;">å¯¾è±¡ç‰©ã‚’æ’®å½±ã—ã¦ãã ã•ã„</div>
            </div>

            <div id="riddle-section" style="display:none;" class="input-group">
                <div style="color:#fbbf24; font-size:0.8rem; font-weight:bold;">MISSION: è¬ã‚’è§£ã„ã¦ãƒã‚¹ã‚’ã€Œç©ºã‘ã‚ã€</div>
                <p id="riddle-text" style="line-height: 1.6; margin: 10px 0;"></p>
                <input type="text" id="answer-input" class="input-text" placeholder="ç­”ãˆã‚’å…¥åŠ›">
                
                <label style="display:block; margin-top:15px; font-size:0.8rem; color:white;">ç©ºã‘ã‚‹å¯¾è±¡ãƒã‚¹ã‚’é¸æŠï¼š</label>
                <select id="target-selector" class="select-box"></select>

                <button class="btn-solve" onclick="finalCheckChain()">ç­”ãˆåˆã‚ã› ï¼† æŒ‡å®šãƒã‚¹ã‚’ç©ºã‘ã‚‹</button>
            </div>
            <button class="btn-close" style="background:#334155; color:white;" onclick="closeModal()">æˆ»ã‚‹</button>
        </div>
    </div>

    <script>
        // clearsId: ã“ã®ãƒã‚¹ã®è¬ã‚’è§£ãã¨ã€Œç©ºãã€ãƒã‚¹ã®ID
        const DEFAULT_BINGO_DATA = [
            { id: 0, target: "ã‚»ãƒ–ãƒ³ã‚¤ãƒ¬ãƒ–ãƒ³", riddle: "ã€Œæœã¯4æœ¬ã€æ˜¼ã¯2æœ¬ã€å¤œã¯3æœ¬ã€ã•ã¦ä½•ï¼Ÿ", answer: "äººé–“", identified: false, solved: false, riddleCleared: false, clearsId: 1 },
            { id: 1, target: "ä»»å¤©å ‚", riddle: "ãƒãƒªã‚ªã®å¸½å­ã®ãƒãƒ¼ã‚¯ã¯ï¼Ÿ", answer: "M", identified: false, solved: false, riddleCleared: false, clearsId: 2 },
            { id: 2, target: "ãƒ‡ã‚£ã‚ºãƒ‹ãƒ¼", riddle: "ãƒŸãƒƒã‚­ãƒ¼ã®èª•ç”Ÿæ—¥ã¯11æœˆä½•æ—¥ï¼Ÿ", answer: "18", identified: false, solved: false, riddleCleared: false, clearsId: 3 },
            { id: 3, target: "ãƒ•ã‚¡ãƒŸãƒ", riddle: "ã€Œã‚ãªãŸã¨ã‚³ãƒ³ãƒ“ã«ã€ã®ç¶šãã¯ï¼Ÿ", answer: "ãƒ•ã‚¡ãƒŸãƒªãƒ¼ãƒãƒ¼ãƒˆ", identified: false, solved: false, riddleCleared: false, clearsId: 4 },
            { id: 4, target: "ãƒ­ãƒ¼ã‚½ãƒ³", riddle: "ãƒ­ã‚´ã®ãƒŸãƒ«ã‚¯ç¼¶ã®è‰²ã¯ï¼Ÿ", answer: "ç™½", identified: false, solved: false, riddleCleared: false, clearsId: 5 },
            { id: 5, target: "ãƒã‚¯ãƒ‰ãƒŠãƒ«ãƒ‰", riddle: "ãƒãƒ†ãƒˆMã‚µã‚¤ã‚ºã®ç›®å®‰gæ•°ã¯ï¼Ÿ", answer: "135", identified: false, solved: false, riddleCleared: false, clearsId: 6 },
            { id: 6, target: "éƒµä¾¿å±€", riddle: "éƒµä¾¿ãƒãƒ¼ã‚¯ï¼ˆã€’ï¼‰ã®ç”±æ¥ã®ã‚«ã‚¿ã‚«ãƒŠã¯ï¼Ÿ", answer: "ãƒ†", identified: false, solved: false, riddleCleared: false, clearsId: 7 },
            { id: 7, target: "ã‚¹ã‚¿ãƒ¼ãƒãƒƒã‚¯ã‚¹", riddle: "ãƒ­ã‚´ã®äººé­šã®åå‰ã¯ï¼Ÿ", answer: "ã‚µã‚¤ãƒ¬ãƒ³", identified: false, solved: false, riddleCleared: false, clearsId: 8 },
            { id: 8, target: "ãƒ€ã‚¤ã‚½ãƒ¼", riddle: "ç¤¾åã®ç”±æ¥ã¯ã€Œå¤§ããâ—â—ã‚‹ã€", answer: "å‰µã‚‹", identified: false, solved: false, riddleCleared: false, clearsId: 9 },
            { id: 9, target: "ãƒ¦ãƒ‹ã‚¯ãƒ­", riddle: "æ­£å¼åç§°ã®æœ€å¾Œã¯ã€Œâ—â—â—ãƒã‚¦ã‚¹ã€", answer: "ã‚¦ã‚§ã‚¢", identified: false, solved: false, riddleCleared: false, clearsId: 10 },
            { id: 10, target: "ãã‚‰å¯¿å¸", riddle: "5çš¿ã§1å›ã§ãã‚‹ã‚²ãƒ¼ãƒ ã¯ï¼Ÿ", answer: "ãƒ“ãƒƒãã‚‰ãƒãƒ³", identified: false, solved: false, riddleCleared: false, clearsId: 11 },
            { id: 11, target: "å‰é‡å®¶", riddle: "ç‰›ã®è§’ã®é–“ã«ã‚ã‚‹ã‚‚ã®ã¯ï¼Ÿ", answer: "ã²ã‚‡ã†ãŸã‚“", identified: false, solved: false, riddleCleared: false, clearsId: 12 },
            { id: 12, target: "ãƒ‹ãƒˆãƒª", riddle: "ãŠã€ã­ã ã‚“â—â—â—", answer: "ä»¥ä¸Š", identified: false, solved: false, riddleCleared: false, clearsId: 13 },
            { id: 13, target: "ã‚¤ã‚ªãƒ³", riddle: "æ—§ç¤¾åã¯ï¼Ÿ", answer: "ã‚¸ãƒ£ã‚¹ã‚³", identified: false, solved: false, riddleCleared: false, clearsId: 14 },
            { id: 14, target: "ã‚¬ã‚¹ãƒˆ", riddle: "çœ‹æ¿ã®èµ¤ã„é³¥ã€‚åå‰ã¯ã‚ã‚‹ï¼Ÿãªã„ï¼Ÿ", answer: "ãªã„", identified: false, solved: false, riddleCleared: false, clearsId: 15 },
            { id: 15, target: "ã‚³ã‚«ã‚³ãƒ¼ãƒ©", riddle: "ã‚µãƒ³ã‚¿ã‚’èµ¤è‰²ã®ã‚¤ãƒ¡ãƒ¼ã‚¸ã«ã—ãŸä¼šç¤¾ã¯ï¼Ÿ", answer: "ã‚³ã‚«ã‚³ãƒ¼ãƒ©", identified: false, solved: false, riddleCleared: false, clearsId: 0 }
        ];

        let BINGO_MASTER = [];
        let itemsCount = 0;
        let completedLines = [];
        let itemMode = false;
        let currentIdx = null;

        function loadGame() {
            const saved = localStorage.getItem('bingo_v3_save');
            if(saved) {
                const data = JSON.parse(saved);
                BINGO_MASTER = data.master;
                itemsCount = data.items || 0;
                completedLines = data.lines || [];
            } else {
                BINGO_MASTER = JSON.parse(JSON.stringify(DEFAULT_BINGO_DATA));
            }
            renderBoard();
            updateItemUI();
        }

        function saveGame() {
            localStorage.setItem('bingo_v3_save', JSON.stringify({
                master: BINGO_MASTER, items: itemsCount, lines: completedLines
            }));
            checkAllClear();
        }

        function renderBoard() {
            const board = document.getElementById("bingo-board");
            board.innerHTML = "";
            const colors = ['col-red', 'col-blue', 'col-green', 'col-yellow'];
            BINGO_MASTER.forEach((d, i) => {
                const cell = document.createElement("div");
                cell.className = `cell ${colors[i % 4]}`;
                if(d.identified) cell.classList.add("identified");
                if(d.solved) cell.classList.add("complete");
                
                let content = `<span>${d.target}</span>`;
                if(d.riddleCleared) content += `<div class="ans-label">ç­”: ${d.answer}</div>`;
                cell.innerHTML = content;
                cell.onclick = () => handleCellClick(i);
                board.appendChild(cell);
            });
        }

        function handleCellClick(i) {
            if (itemMode) useItemOnCell(i);
            else openModal(i);
        }

        function updateItemUI() {
            document.getElementById("item-count").innerText = itemsCount;
            document.getElementById("use-item-btn").disabled = itemsCount <= 0;
            document.getElementById("use-item-btn").innerText = itemMode ? "ã‚­ãƒ£ãƒ³ã‚»ãƒ«" : "ã‚¢ã‚¤ãƒ†ãƒ ã‚’ä½¿ã†";
        }

        function toggleItemMode() {
            if (itemsCount <= 0) return;
            itemMode = !itemMode;
            updateItemUI();
            if (itemMode) alert("ã€Œé–‹æ”¾(ã‚¹ã‚­ãƒ£ãƒ³)ã€ã‚’ã‚¹ã‚­ãƒƒãƒ—ã™ã‚‹ãƒã‚¹ã‚’é¸ã‚“ã§ãã ã•ã„ã€‚");
        }

        function useItemOnCell(i) {
            const data = BINGO_MASTER[i];
            if (data.identified || data.solved) return alert("ã™ã§ã«ã€Œé–‹æ”¾ã€æ¸ˆã¿ã§ã™ã€‚");
            if (confirm(`${data.target} ã‚’ã‚¹ã‚­ãƒ£ãƒ³ãªã—ã§é–‹æ”¾ã—ã¾ã™ã‹ï¼Ÿ`)) {
                itemsCount--; data.identified = true; itemMode = false;
                saveGame(); updateItemUI(); renderBoard(); openModal(i);
            }
        }

        async function openModal(i) {
            currentIdx = i;
            const data = BINGO_MASTER[i];
            document.getElementById("modal-title").innerText = data.target;
            document.getElementById("modal").style.display = "block";
            
            // ã‚»ãƒ¬ã‚¯ãƒˆãƒœãƒƒã‚¯ã‚¹ã®ç”Ÿæˆ
            const sel = document.getElementById("target-selector");
            sel.innerHTML = '<option value="">â–¼ ç©ºã‘ã‚‹ãƒã‚¹ã‚’é¸æŠ</option>';
            BINGO_MASTER.forEach((m, idx) => {
                if(!m.solved) {
                    const opt = document.createElement("option");
                    opt.value = idx;
                    opt.innerText = `ãƒã‚¹${idx+1}: ${m.target}`;
                    sel.appendChild(opt);
                }
            });

            if(data.identified) {
                document.getElementById("capture-section").style.display = "none";
                document.getElementById("riddle-section").style.display = "block";
                document.getElementById("riddle-text").innerText = data.riddle;
                document.getElementById("answer-input").value = data.riddleCleared ? data.answer : "";
            } else {
                document.getElementById("capture-section").style.display = "block";
                document.getElementById("riddle-section").style.display = "none";
                document.getElementById("video").style.display = "block";
                document.getElementById("canvas").style.display = "none";
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
                    document.getElementById("video").srcObject = stream;
                } catch (e) { alert("ã‚«ãƒ¡ãƒ©ä¸å¯"); }
            }
        }

        async function analyzeSpot() {
            const apiKey = document.getElementById("test-api-key").value.trim();
            if(!apiKey) return alert("APIã‚­ãƒ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
            const video = document.getElementById("video");
            const canvas = document.getElementById("canvas");
            const data = BINGO_MASTER[currentIdx];

            canvas.width = video.videoWidth; canvas.height = video.videoHeight;
            canvas.getContext("2d").drawImage(video, 0, 0);
            video.style.display = "none"; canvas.style.display = "block";
            document.getElementById("ai-status").innerText = "è§£æä¸­...";

            const imgBase64 = canvas.toDataURL("image/jpeg", 0.7).split(",")[1];
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [
                        { text: `ç”»åƒã«ã€Œ${data.target}ã€ã®ãƒ­ã‚´ã‚„å»ºç‰©ãŒã‚ã‚‹ã‹ã€Œã¯ã„ã€ã‹ã€Œã„ã„ãˆã€ã§ç­”ãˆã¦ã€‚` },
                        { inline_data: { mime_type: "image/jpeg", data: imgBase64 } }
                    ] }] })
                });
                const res = await response.json();
                if(res.candidates[0].content.parts[0].text.trim().includes("ã¯ã„")) {
                    alert("ã‚¹ã‚­ãƒ£ãƒ³æˆåŠŸï¼ã€Œé–‹æ”¾ã€ã•ã‚Œã¾ã—ãŸã€‚");
                    data.identified = true; saveGame();
                    document.getElementById("capture-section").style.display = "none";
                    document.getElementById("riddle-section").style.display = "block";
                    document.getElementById("riddle-text").innerText = data.riddle;
                } else { alert("åˆ¤å®šå¤±æ•—"); video.style.display = "block"; canvas.style.display = "none"; }
            } catch (e) { alert("Error: " + e.message); }
        }

        function finalCheckChain() {
            const ansInput = document.getElementById("answer-input").value.trim();
            const targetIdx = document.getElementById("target-selector").value;
            const currentData = BINGO_MASTER[currentIdx];

            if(ansInput !== currentData.answer) return alert("ç­”ãˆãŒé•ã„ã¾ã™ã€‚");
            if(targetIdx === "") return alert("ç©ºã‘ã‚‹å¯¾è±¡ã®ãƒã‚¹ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚");

            // é€£é–ãƒã‚§ãƒƒã‚¯ï¼šæ­£ã—ã„ãƒã‚¹ã‚’é¸æŠã—ã¦ã„ã‚‹ã‹
            if(parseInt(targetIdx) !== currentData.clearsId) {
                return alert("å¯¾è±¡ãƒã‚¹ã§ã¯ãªã„ã§ã™ã€‚(ã“ã®è¬ã¯åˆ¥ã®å ´æ‰€ã‚’ç©ºã‘ã‚‹ãŸã‚ã®ã‚‚ã®ã§ã™)");
            }

            // é–‹æ”¾ãƒã‚§ãƒƒã‚¯ï¼šå¯¾è±¡ãƒã‚¹ãŒé–‹æ”¾ã•ã‚Œã¦ã„ã‚‹ã‹
            const targetData = BINGO_MASTER[currentData.clearsId];
            if(!targetData.identified) {
                return alert(`${targetData.target} ãŒã¾ã ã€Œé–‹æ”¾ã€ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚å…ˆã«ã‚¹ã‚­ãƒ£ãƒ³ã—ã¦ãã¦ãã ã•ã„ã€‚`);
            }

            alert(`æ­£è§£ï¼ ${targetData.target} ãŒã€Œç©ºãã€ã¾ã—ãŸã€‚`);
            currentData.riddleCleared = true;
            targetData.solved = true;
            saveGame();
            checkBingo();
            closeModal();
        }

        function checkBingo() {
            const winPatterns = [
                [0,1,2,3],[4,5,6,7],[8,9,10,11],[12,13,14,15], // æ¨ª
                [0,4,8,12],[1,5,9,13],[2,6,10,14],[3,7,11,15], // ç¸¦
                [0,5,10,15],[3,6,9,12] // æ–œã‚
            ];
            let newBingo = false;
            winPatterns.forEach((pattern, index) => {
                if (pattern.every(idx => BINGO_MASTER[idx].solved) && !completedLines.includes(index)) {
                    completedLines.push(index); itemsCount++; newBingo = true;
                }
            });
            if (newBingo) {
                const overlay = document.getElementById("bingo-overlay");
                overlay.style.display = "flex";
                setTimeout(() => overlay.style.display = "none", 3000);
                saveGame(); updateItemUI();
            }
        }

        function checkAllClear() {
            if(BINGO_MASTER.every(d => d.solved)) {
                document.getElementById("game-clear-overlay").style.display = "flex";
            }
        }

        function closeModal() {
            const v = document.getElementById("video");
            if (v.srcObject) v.srcObject.getTracks().forEach(t => t.stop());
            document.getElementById("modal").style.display = "none";
            renderBoard();
        }

        function resetGame() {
            if(confirm("ãƒªã‚»ãƒƒãƒˆï¼Ÿ")) { localStorage.removeItem('bingo_v3_save'); location.reload(); }
        }

        loadGame();
    </script>
</body>
</html>
