<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BINGO MYSTERY AI - Strategic Mode</title>
    <style>
        :root { --bg: #0f172a; --glass: rgba(255, 255, 255, 0.1); }
        .col-red { --theme: #ff4d4d; } .col-blue { --theme: #4d94ff; } .col-green { --theme: #2ecc71; } .col-yellow { --theme: #f1c40f; }

        body { font-family: sans-serif; background: var(--bg); color: white; margin: 0; padding: 10px; display: flex; flex-direction: column; align-items: center; min-height: 100vh; overflow-x: hidden; }
        
        .command-section { width: 95%; max-width: 400px; background: var(--glass); padding: 10px; border-radius: 12px; margin-bottom: 10px; border: 1px dashed #475569; box-sizing: border-box; }
        .command-section input { width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #334155; background: #000; color: #fff; box-sizing: border-box; }
        .command-section button { margin-top: 5px; padding: 8px; font-size: 0.8rem; background: #334155; color: white; border: none; border-radius: 5px; width: 100%; cursor: pointer; }

        .item-inventory { width: 95%; max-width: 400px; display: flex; justify-content: space-between; align-items: center; background: rgba(255,255,255,0.05); padding: 10px 15px; border-radius: 15px; margin-bottom: 10px; border: 1px solid gold; box-sizing: border-box; }
        .item-btn { background: linear-gradient(135deg, gold, #f39c12); color: black; border: none; padding: 8px 15px; border-radius: 20px; font-weight: bold; cursor: pointer; font-size: 0.8rem; }

        .reset-area { width: 95%; max-width: 400px; display: flex; gap: 10px; margin-bottom: 15px; }
        .btn-soft-reset { flex: 1; background: rgba(255,255,255,0.05); color: #aaa; border: 1px solid #444; padding: 8px; font-size: 0.6rem; border-radius: 5px; cursor: pointer; }

        .bingo-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; width: 100%; max-width: 400px; margin-bottom: 20px; }
        .cell { aspect-ratio: 1/1; background: var(--glass); border: 2px solid var(--theme); border-radius: 10px; display: flex; flex-direction: column; justify-content: center; align-items: center; font-size: 0.6rem; font-weight: bold; text-align: center; cursor: pointer; padding: 5px; box-sizing: border-box; color: var(--theme); transition: 0.3s; }
        .cell.identified { background: rgba(255, 255, 255, 0.05); box-shadow: inset 0 0 10px var(--theme); color: #fff; } 
        .cell.complete { background: var(--theme); color: #000; border: none; box-shadow: 0 0 15px var(--theme); }
        .ans-label { font-size: 0.5rem; margin-top: 4px; border-top: 1px solid rgba(0,0,0,0.2); width: 100%; padding-top: 2px; }

        #solution-deck { display: none; width: 95%; max-width: 400px; margin-top: 20px; }
        .solution-card { background: rgba(255,255,255,0.05); border-left: 4px solid var(--theme); margin-bottom: 8px; padding: 10px; border-radius: 8px; font-size: 0.8rem; display: flex; justify-content: space-between; align-items: center; }

        /* ã‚°ãƒªãƒƒãƒæ¼”å‡ºç”¨ã‚¹ã‚¿ã‚¤ãƒ« */
        @keyframes glitch-anim {
            0% { transform: translate(0); filter: hue-rotate(0deg); }
            20% { transform: translate(-10px, 5px); filter: invert(1); }
            40% { transform: translate(10px, -5px); filter: hue-rotate(180deg); }
            60% { transform: translate(-5px, -10px); filter: brightness(2); }
            80% { transform: translate(5px, 5px); filter: contrast(3); }
            100% { transform: translate(0); filter: hue-rotate(0deg); }
        }
        .glitch-active { animation: glitch-anim 0.15s infinite !important; background: #f00 !important; color: #000 !important; }

        #clear-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 2000; flex-direction: column; justify-content: center; align-items: center; background: radial-gradient(circle, #1e293b, #000); text-align: center; padding: 20px; box-sizing: border-box; }
        .clear-card { background: rgba(255,255,255,0.05); padding: 30px 20px; border-radius: 30px; border: 2px solid gold; box-shadow: 0 0 50px rgba(212, 175, 55, 0.3); width: 90%; max-width: 400px; position: relative; z-index: 2100; }
        .gold-title { font-size: 2.5rem; font-weight: bold; background: linear-gradient(to bottom, #fff, #d4af37); -webkit-background-clip: text; -webkit-text-fill-color: transparent; filter: drop-shadow(0 0 10px gold); margin-bottom: 15px; }

        #modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 100; padding: 15px; box-sizing: border-box; overflow-y: auto; }
        #view-container { width: 100%; aspect-ratio: 1/1; background: #000; border-radius: 15px; overflow: hidden; margin: 10px 0; border: 2px solid #334155; position: relative; }
        video, canvas { width: 100%; height: 100%; object-fit: cover; position: absolute; top: 0; left: 0; }
        .action-btn { border: none; border-radius: 10px; padding: 14px; font-weight: bold; cursor: pointer; width: 100%; font-size: 1rem; margin-top: 10px; }
        .btn-target { background: #1e293b; color: white; border: 1px solid #4facfe; font-size: 0.8rem; padding: 10px; margin-bottom: 5px; border-radius: 8px; width: 100%; text-align: left; }
        .nav-link { display: inline-block; margin: 20px 0; padding: 12px 30px; background: rgba(255, 255, 255, 0.05); border: 1px solid #4facfe; color: #4facfe; text-decoration: none; border-radius: 30px; font-size: 0.8rem; font-weight: bold; }
    </style>
</head>
<body>

    <h2 style="margin: 10px 0;">BINGO MYSTERY AI</h2>

    <div class="command-section">
        <input type="text" id="command-input" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›...">
        <button onclick="executeCommand()">é€ä¿¡</button>
    </div>

    <div class="item-inventory">
        <div>
            <span style="font-size: 0.6rem; color: gold; display: block;">ITEM: ãƒã‚¹ã‚¿ãƒ¼ã‚­ãƒ¼</span>
            <span id="item-count" style="font-size: 1.2rem; font-weight: bold;">0</span>
        </div>
        <button id="use-item-btn" class="item-btn" onclick="toggleItemMode()">ã‚¢ã‚¤ãƒ†ãƒ ã‚’ä½¿ã†</button>
    </div>

    <div class="reset-area">
        <button class="btn-soft-reset" onclick="softReset()">å›ç­”ã®ã¿ãƒªã‚»ãƒƒãƒˆ</button>
        <button style="background:none; color:#444; border:none; font-size:0.6rem;" onclick="resetGame()">å®Œå…¨ãƒªã‚»ãƒƒãƒˆ</button>
    </div>

    <div class="bingo-grid" id="bingo-board"></div>
    <div id="solution-deck"></div>

    <a href="index.html" class="nav-link">ã‚¿ã‚¤ãƒˆãƒ«ç”»é¢ã¸æˆ»ã‚‹</a>

    <div id="clear-overlay">
        <div id="confetti-container"></div>
        <div class="clear-card">
            <div id="clear-title" class="gold-title">FINISH</div>
            <p id="clear-msg" style="line-height: 1.6; margin-bottom: 20px; white-space: pre-wrap;"></p>
            <button id="close-finale-btn" style="background:#fff; color:#000; padding:10px; border-radius:10px; width:100%; border:none; font-weight:bold;" onclick="closeFinale()">æ¬¡ã¸</button>
        </div>
    </div>

    <div id="bingo-overlay" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:1500; flex-direction:column; justify-content:center; align-items:center; pointer-events:none;">
        <div style="font-size:4rem; font-weight:bold; color:gold;">BINGO!</div>
    </div>

    <div id="modal">
        <div class="modal-content" style="max-width: 400px; margin: auto;">
            <h2 id="modal-title" style="color:#4facfe; margin:0 0 10px 0;">TARGET</h2>
            <div id="capture-section">
                <div id="view-container"><video id="video" autoplay playsinline></video><canvas id="canvas"></canvas></div>
                <button class="action-btn" style="background:#4facfe; color:white;" onclick="analyzeSpot()">ğŸ“¸ æ’®å½±ã—ã¦ã€Œé–‹æ”¾ã€ã™ã‚‹</button>
            </div>
            <div id="riddle-section" style="display:none;" class="input-group">
                <div id="riddle-display-area" style="width:100%; height:300px; background:#111; border-radius:10px; margin-bottom:10px; display:flex; justify-content:center; align-items:center; border:1px solid #334155;"><img id="riddle-image" src="" style="max-width:100%; max-height:100%; object-fit:contain;"></div>
                <input type="text" id="answer-input" style="width:100%; padding:12px; border-radius:8px; background:#1e293b; color:white; border:1px solid #475569; box-sizing:border-box;" placeholder="ç­”ãˆã‚’å…¥åŠ›">
                <button id="check-ans-btn" class="action-btn" style="background:#fbbf24; color:black;" onclick="verifyAnswer()">æ­£è§£åˆ¤å®šã™ã‚‹</button>
                <div id="target-selection-area" style="display:none; margin-top:20px; border-top:1px solid #444; padding-top:15px;">
                    <label id="selection-label" style="display:block; font-size:0.8rem; color:#4facfe; margin-bottom:10px;">é–‹æ”¾ã™ã‚‹ãƒã‚¹ã‚’é¸æŠï¼š</label>
                    <div id="target-list"></div>
                </div>
            </div>
            <button class="action-btn" style="background:#334155; color:white;" onclick="closeModal()">æˆ»ã‚‹</button>
        </div>
    </div>

    <script>
        const DEFAULT_DATA = [
            { id: 0, color: 'blue', target: "å‘³ã®ç´ ", riddle:"images/1.png", answer: "ã‚­ãƒªãƒ³", trueAnswer: "ã‚­ãƒªãƒ³", identified: false, solved: false, riddleCleared: false, clearsId: 6 },
            { id: 1, color: 'red', target: "ã‚¹ã‚¿ãƒ¼ãƒãƒƒã‚¯ã‚¹", riddle: "images/2.png", answer: ["äº¬éƒ½","äº¬éƒ½åºœ","kyotofu"], trueAnswer: ["äº¬éƒ½","äº¬éƒ½åºœ","kyotofu"], identified: false, solved: false, riddleCleared: false, clearsId: 5 },
            { id: 2, color: 'yellow', target: "ã™ãå®¶", riddle: "images/3.png", answer: ["ã‚¬ã‚»","GASE","Gase","gase"], trueAnswer: ["ã‚¬ã‚»","GASE","Gase","gase"], identified: false, solved: false, riddleCleared: false, clearsId: 4 },
            { id: 3, color: 'green', target: "ãƒ‹ãƒˆãƒª", riddle: "images/4.png", answer: ["èµ¤","ã‚ã‹"], trueAnswer: ["èµ¤","ã‚ã‹"], identified: false, solved: false, riddleCleared: false, clearsId: 9 },
            { id: 4, color: 'yellow', target: "SEGA", riddle: "images/5.png", answer: "è«–äº‰", trueAnswer: "è«–äº‰", identified: false, solved: false, riddleCleared: false, clearsId: 8 },
            { id: 5, color: 'red', target: "ä»»å¤©å ‚", riddle: "images/6.png", answer: "åŒ—æµ·é“", trueAnswer: "åŒ—æµ·é“", identified: false, solved: false, riddleCleared: false, clearsId: 7 },
            { id: 6, color: 'blue', target: "ã‚»ãƒ–ãƒ³ã‚¤ãƒ¬ãƒ–ãƒ³", riddle: "images/7.png", answer: ["lion","Lion","ãƒ©ã‚¤ã‚ªãƒ³"], trueAnswer: ["lion","Lion","ãƒ©ã‚¤ã‚ªãƒ³"], identified: false, solved: false, riddleCleared: false, clearsId: 13 },
            { id: 7, color: 'red', target: "é›ªå°ãƒ¡ã‚°ãƒŸãƒ«ã‚¯", riddle: "images/8.png", answer: "ã‚·ã‚¢ãƒˆãƒ«", trueAnswer: "ã‚·ã‚¢ãƒˆãƒ«", identified: false, solved: false, riddleCleared: false, clearsId: 1 },
            { id: 8, color: 'yellow', target: "ãƒ­ãƒ¼ã‚½ãƒ³", riddle: "images/9.png", answer: "ã™ã‚„ã", trueAnswer: "ã™ã‚„ã", identified: false, solved: false, riddleCleared: false, clearsId: 2 },
            { id: 9, color: 'green', target: "UNIQLO", riddle: "images/10.png", answer: ["ç´«","ã‚€ã‚‰ã•ã"], trueAnswer: ["ç´«","ã‚€ã‚‰ã•ã"], identified: false, solved: false, riddleCleared: false, clearsId: 12 },
            { id: 10, color: 'green', target: "ãƒãƒ„ãƒ¢ãƒˆã‚­ãƒ¨ã‚·", riddle: "images/11.png", answer: "ãƒãƒ„ã‚­ãƒ¨", trueAnswer: ["é»„è‰²","é»„"], identified: false, solved: false, riddleCleared: false, clearsId: 10 },
            { id: 11, color: 'red', target: "ä¸¸äº€è£½éºº", riddle: "images/12.png", answer: ["marugame","ä¸¸äº€","ã¾ã‚‹ãŒã‚"], trueAnswer: ["æ±äº¬","æ±äº¬éƒ½","æ¸‹è°·"], identified: false, solved: false, riddleCleared: false, clearsId: 11 },
            { id: 12, color: 'green', target: "ã‚¤ã‚ªãƒ³", riddle: "images/13.png", answer: "ç·‘", trueAnswer: "ç·‘", identified: false, solved: false, riddleCleared: false, clearsId: 3 },
            { id: 13, color: 'blue', target: "ãƒŸã‚¹ã‚¿ãƒ¼ãƒ‰ãƒ¼ãƒŠãƒ„", riddle: "images/14.png", answer: ["ãƒ‘ãƒ³ãƒ€","PANDA","panda"], trueAnswer: ["ãƒ‘ãƒ³ãƒ€","PANDA","panda"], identified: false, solved: false, riddleCleared: false, clearsId: 0 },
            { id: 14, color: 'blue', target: "ãŸã‹ã‚‰ãã˜", riddle: "images/15.png", answer: ["ãŸã‹ã‚‰ãã˜","å®ãã˜"], trueAnswer: "ãã˜ã‚‰", identified: false, solved: false, riddleCleared: false, clearsId: 14 },
            { id: 15, color: 'yellow', target: "ã‚³ã‚¯ãƒ¨", riddle: "images/16.png", answer: "ã‚³ã‚¯ãƒ¨", trueAnswer: ["äºˆå‘Š","ãƒ¨ã‚³ã‚¯","ã‚ˆã“ã"], identified: false, solved: false, riddleCleared: false, clearsId: 15 }
        ];

        let MASTER = []; let route = 'none'; let items = 0; let lines = []; let current = null; 
        let itemMode = false; let finaleSeen = false; let limitMode = false;

        const normalize = (v) => v ? v.toString().replace(/[ï¼-ï½]/g, s => String.fromCharCode(s.charCodeAt(0) - 0xFEE0)).replace(/[\u3041-\u3096]/g, s => String.fromCharCode(s.charCodeAt(0) + 0x60)).toLowerCase().trim() : "";

        function load() {
            const saved = localStorage.getItem('bingo_grand_v11_save');
            if(saved) {
                const d = JSON.parse(saved); MASTER = d.m; route = d.r; items = d.i; lines = d.l; finaleSeen = d.f || false;
            } else { MASTER = JSON.parse(JSON.stringify(DEFAULT_DATA)); }
            render(); updateUI();
            if(MASTER.every(c => c.solved) && !finaleSeen) showFinale();
        }

        function save() { 
            localStorage.setItem('bingo_grand_v11_save', JSON.stringify({ m: MASTER, r: route, i: items, l: lines, f: finaleSeen })); 
            if(MASTER.every(c => c.solved) && !finaleSeen) showFinale();
        }

        function render() {
            const board = document.getElementById("bingo-board"); board.innerHTML = "";
            MASTER.forEach((d, i) => {
                const cell = document.createElement("div"); cell.className = `cell col-${d.color}`;
                if(d.identified) cell.classList.add("identified");
                if(d.solved) cell.classList.add("complete");
                let ans = (route === 'cross') ? (Array.isArray(d.trueAnswer) ? d.trueAnswer[0] : d.trueAnswer) : (Array.isArray(d.answer) ? d.answer[0] : d.answer);
                cell.innerHTML = `<span>${d.target}</span>` + (d.riddleCleared ? `<div class="ans-label">ç­”: ${ans}</div>` : "");
                cell.onclick = () => itemMode ? useItem(i) : (limitMode ? showCheatAnswer(i) : openModal(i));
                board.appendChild(cell);
            });
        }

        function updateUI() {
            document.getElementById("item-count").innerText = items;
            const b = document.getElementById("use-item-btn"); b.disabled = items <= 0;
            b.innerText = itemMode ? "CANCEL" : "ITEM USE"; b.style.background = itemMode ? "#ef4444" : "";
        }

        function verifyAnswer() {
            const input = normalize(document.getElementById("answer-input").value);
            const d = MASTER[current];
            const check = (userInput, dataValue) => Array.isArray(dataValue) ? dataValue.some(v => normalize(v) === userInput) : normalize(dataValue) === userInput;

            const okN = check(input, d.answer);
            const okT = check(input, d.trueAnswer);
            
            if(route === 'cross' && !okT) return alert("ä¸æ­£è§£ï¼ˆçœŸå®Ÿã®ç­”ãˆã§ã¯ã‚ã‚Šã¾ã›ã‚“ï¼‰");
            if(route === 'self' && !okN) return alert("ä¸æ­£è§£ï¼ˆé€šå¸¸ãƒ«ãƒ¼ãƒˆï¼‰");
            if(route === 'none' && !okN && !okT) return alert("ä¸æ­£è§£");

            document.getElementById("check-ans-btn").disabled = true;
            document.getElementById("target-selection-area").style.display = "block";
            renderTargetButtons(okN, okT);
        }

        function renderTargetButtons(okN, okT) {
            const list = document.getElementById("target-list"); list.innerHTML = "";
            MASTER.forEach((m, idx) => {
                if(!m.solved && m.identified) {
                    const btn = document.createElement("button"); btn.className = "btn-target";
                    btn.innerText = `ãƒã‚¹${idx+1}: ${m.target}`;
                    btn.onclick = () => finalize(idx, okN, okT);
                    list.appendChild(btn);
                }
            });
        }

        function finalize(targetIdx, okN, okT) {
            const currentCell = MASTER[current];
            const isSelfChoice = (targetIdx === current);
            const isCrossChoice = (targetIdx === currentCell.clearsId);

            if (isCrossChoice && okT) {
                if (route !== 'cross') {
                    route = 'cross';
                    triggerGlitch(); // ã‚°ãƒªãƒƒãƒï¼†ãƒªã‚»ãƒƒãƒˆæ¼”å‡º
                }
            } else if (isSelfChoice && okN) {
                if (route === 'cross') return alert("è­¦å‘Šï¼šæ­£è¦è§£ç­”ã¯æ‹’å¦ã•ã‚Œã¾ã—ãŸã€‚é€£é–å…ˆã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚");
                if (route === 'none') route = 'self';
            } else { return alert("å¯¾è±¡ãƒã‚¹ã¾ãŸã¯è§£ç­”ãŒä¸€è‡´ã—ã¾ã›ã‚“ã€‚"); }

            alert("ãƒã‚¹ãŒç©ºãã¾ã—ãŸï¼");
            MASTER[current].riddleCleared = true; MASTER[targetIdx].solved = true;
            save(); checkBingo(); closeModal(); render();
        }

        function triggerGlitch() {
            document.body.classList.add("glitch-active");
            
            // é‡è¦ï¼šã“ã“ã§ãƒãƒ¼ãƒãƒ«è§£ç­”ã§é–‹æ”¾ã—ãŸãƒã‚¹ã‚’ãƒªã‚»ãƒƒãƒˆ
            MASTER.forEach(d => {
                d.solved = false; 
                d.riddleCleared = false;
            });
            lines = []; // ãƒ“ãƒ³ã‚´ãƒ©ã‚¤ãƒ³ã‚‚ãƒªã‚»ãƒƒãƒˆ
            items = 0;  // ã‚¢ã‚¤ãƒ†ãƒ ã‚‚ãƒªã‚»ãƒƒãƒˆ

            setTimeout(() => {
                document.body.classList.remove("glitch-active");
                alert("ã€è‡´å‘½çš„ãªã‚·ã‚¹ãƒ†ãƒ ã‚¨ãƒ©ãƒ¼ã€‘\né€£é–ã®çŸ›ç›¾ã«ã‚ˆã‚Šã€å…¨ãƒã‚¹ã®å›ºå®šã‚’è§£é™¤ã—ã¾ã™ã€‚\nçœŸå®Ÿã®è§£ç­”ã®ã¿ãŒã“ã®æ­ªã¿ã‚’æ­£ã™ã“ã¨ãŒã§ãã¾ã™ã€‚");
                render(); 
                updateUI();
            }, 1800);
        }

        function showFinale() {
            const overlay = document.getElementById("clear-overlay");
            const title = document.getElementById("clear-title");
            const msg = document.getElementById("clear-msg");
            const deck = document.getElementById("solution-deck");
            overlay.style.display = "flex";

            if(route === 'self') {
                title.innerText = "NORMAL END";
                msg.innerText = "ã‚¯ãƒªã‚¢ç‡80ï¼…/nãƒ“ãƒ³ã‚´ã®ä¸‹ã«æ‰‹ãŒã‹ã‚Šã‚’è¡¨ç¤ºã—ã¾ã—ãŸã€‚/nå•é¡Œã®ç­”ãˆãŒã™ã¹ã¦å…¥ã‚Œæ›¿ã‚ã£ã¦/nã„ãã¤ã‹ã®å•é¡Œã«ã¤ã„ã¦ã¯å•é¡Œã”ã¨ã™ã‚Šæ›¿ã‚ã£ã¦ã„ã‚‹ã¿ãŸã„ã§ã™ã€‚";
                deck.style.display = "block";
                deck.innerHTML = `<h3 style="color: gold; font-size: 0.8rem; border-bottom: 1px solid #444; margin-bottom: 10px;">COLLECTED HINTS</h3>`;
                MASTER.forEach((d, i) => {
                    const nA = Array.isArray(d.answer) ? d.answer[0] : d.answer;
                    const card = document.createElement("div");
                    card.className = `solution-card col-${d.color}`;
                    card.innerHTML = `<span style="color:var(--theme); font-weight:bold;">No.${i+1}: ${d.target}</span><span style="color:#fff;">ç­”: ${nA}</span>`;
                    deck.appendChild(card);
                });
            } else {
                title.innerHTML = "TRUE ENDING";
                msg.innerText = "ã‚¯ãƒªã‚¢ç‡100ï¼…ï¼ï¼\nå…¨ã¦ã®é€£é–ã‚’è§£ãæ˜ã‹ã—ã€çœŸå®Ÿã®ç­”ãˆã«è¾¿ã‚Šç€ãã¾ã—ãŸï¼";
                deck.style.display = "none";
                createConfetti();
            }
        }

        function softReset() {
            if(confirm("æ’®å½±ãƒ‡ãƒ¼ã‚¿ï¼ˆé–‹æ”¾çŠ¶æ…‹ï¼‰ã‚’ç¶­æŒã—ãŸã¾ã¾å›ç­”ã®ã¿ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ")) {
                MASTER.forEach(d => { d.solved = false; d.riddleCleared = false; });
                route = 'none'; items = 0; lines = []; finaleSeen = false;
                document.getElementById("solution-deck").style.display = "none";
                save(); location.reload();
            }
        }

        function resetGame() { if(confirm("å…¨ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¦åˆæœŸåŒ–ã—ã¾ã™ã‹ï¼Ÿ")) { localStorage.clear(); location.reload(); } }

        function toggleItemMode() { itemMode = !itemMode; updateUI(); }
        function useItem(i) {
            if(MASTER[i].identified || MASTER[i].solved) return;
            items--; MASTER[i].identified = true; itemMode = false; save(); updateUI(); render(); openModal(i);
        }

        async function openModal(i) {
            current = i; const d = MASTER[i];
            document.getElementById("modal-title").innerText = d.target; document.getElementById("modal").style.display = "block";
            document.getElementById("target-selection-area").style.display = "none"; document.getElementById("check-ans-btn").disabled = false;
            if(d.identified) {
                document.getElementById("capture-section").style.display = "none"; document.getElementById("riddle-section").style.display = "block";
                document.getElementById("riddle-image").src = d.riddle;
            } else {
                document.getElementById("capture-section").style.display = "block"; document.getElementById("riddle-section").style.display = "none";
                const s = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } }); document.getElementById("video").srcObject = s;
            }
        }

        async function analyzeSpot() {
            const v = document.getElementById("video"); const c = document.getElementById("canvas");
            c.width = v.videoWidth; c.height = v.videoHeight; c.getContext("2d").drawImage(v, 0, 0);
            const imgData = c.toDataURL("image/jpeg", 0.7).split(",")[1];
            try {
                const response = await fetch('/.netlify/functions/analyze', { method: 'POST', body: JSON.stringify({ target: MASTER[current].target, image: imgData }) });
                const data = await response.json();
                if (data.result && data.result.toUpperCase().includes("YES")) {
                    MASTER[current].identified = true; save();
                    document.getElementById("capture-section").style.display = "none"; document.getElementById("riddle-section").style.display = "block";
                    document.getElementById("riddle-image").src = MASTER[current].riddle;
                } else { alert("åˆ¤å®šå¤±æ•—"); }
            } catch (e) { alert("AI Error"); }
        }

        function checkBingo() {
            const p = [[0,1,2,3],[4,5,6,7],[8,9,10,11],[12,13,14,15],[0,4,8,12],[1,5,9,13],[2,6,10,14],[3,7,11,15],[0,5,10,15],[3,6,9,12]];
            let hit = false;
            p.forEach((line, i) => { if(line.every(idx => MASTER[idx].solved) && !lines.includes(i)) { lines.push(i); items++; hit = true; } });
            if(hit) { document.getElementById("bingo-overlay").style.display = "flex"; setTimeout(()=>document.getElementById("bingo-overlay").style.display="none", 2500); updateUI(); }
        }

        function closeFinale() {
            if(route === 'self') {
                MASTER.forEach(d => { d.solved = false; d.riddleCleared = false; });
                route = 'none'; items = 0; lines = []; finaleSeen = false;
            } else { finaleSeen = true; }
            save(); document.getElementById("clear-overlay").style.display = "none"; render();
        }

        function createConfetti() {
            const container = document.getElementById("confetti-container"); container.innerHTML = "";
            for(let i=0; i<60; i++) {
                const c = document.createElement("div"); c.className = "confetti";
                c.style.left = Math.random() * 100 + "vw"; c.style.animationDelay = Math.random() * 3 + "s";
                container.appendChild(c);
            }
        }

        function closeModal() {
            const v = document.getElementById("video"); if(v.srcObject) v.srcObject.getTracks().forEach(t=>t.stop());
            document.getElementById("modal").style.display = "none"; render();
        }

        function executeCommand() {
            const input = document.getElementById("command-input").value.trim();
            if (input === "ã‚‚ã†ã‚ã‹ã‚‰ãªã„") { items += 5; updateUI(); save(); alert("ãƒã‚¹ã‚¿ãƒ¼ã‚­ãƒ¼5å€‹å–å¾—ã€‚"); }
            else if (input === "ã‚‚ã†é™ç•Œ") { limitMode = true; alert("å›ç­”è¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰ã€‚"); }
            document.getElementById("command-input").value = "";
        }
        function showCheatAnswer(i) { alert(`ç­”: ${Array.isArray(MASTER[i].answer) ? MASTER[i].answer[0] : MASTER[i].answer}`); limitMode = false; }

        load();
    </script>
</body>
</html>
