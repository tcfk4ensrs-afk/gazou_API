<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BINGO MYSTERY AI - Strategic Mode</title>
    <style>
        :root { --bg: #0f172a; --glass: rgba(255, 255, 255, 0.1); }
        .col-red { --theme: #ff4d4d; } .col-blue { --theme: #4d94ff; } .col-green { --theme: #2ecc71; } .col-yellow { --theme: #f1c40f; }

        body { font-family: sans-serif; background: var(--bg); color: white; margin: 0; padding: 10px; display: flex; flex-direction: column; align-items: center; min-height: 100vh; overflow-x: hidden; }
        
        .setup-section { width: 95%; max-width: 400px; background: var(--glass); padding: 10px; border-radius: 12px; margin-bottom: 10px; border: 1px dashed #4facfe; box-sizing: border-box; }
        .setup-section input { width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #334155; background: #000; color: #fff; box-sizing: border-box; }

        .item-inventory { width: 95%; max-width: 400px; display: flex; justify-content: space-between; align-items: center; background: rgba(255,255,255,0.05); padding: 10px 15px; border-radius: 15px; margin-bottom: 15px; border: 1px solid gold; box-sizing: border-box; }
        .item-btn { background: linear-gradient(135deg, gold, #f39c12); color: black; border: none; padding: 8px 15px; border-radius: 20px; font-weight: bold; cursor: pointer; font-size: 0.8rem; }

        .bingo-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; width: 100%; max-width: 400px; margin-bottom: 20px; }
        .cell { aspect-ratio: 1/1; background: var(--glass); border: 2px solid var(--theme); border-radius: 10px; display: flex; flex-direction: column; justify-content: center; align-items: center; font-size: 0.6rem; font-weight: bold; text-align: center; cursor: pointer; padding: 5px; box-sizing: border-box; color: var(--theme); transition: 0.3s; }
        .cell.identified { background: rgba(255, 255, 255, 0.05); box-shadow: inset 0 0 10px var(--theme); color: #fff; } 
        .cell.complete { background: var(--theme); color: #000; border: none; box-shadow: 0 0 15px var(--theme); }
        .ans-label { font-size: 0.5rem; margin-top: 4px; border-top: 1px solid rgba(0,0,0,0.2); width: 100%; padding-top: 2px; }

        #clear-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 2000; flex-direction: column; justify-content: center; align-items: center; background: radial-gradient(circle, #1e293b, #000); text-align: center; padding: 20px; box-sizing: border-box; }
        .clear-card { background: rgba(255,255,255,0.05); padding: 30px 20px; border-radius: 30px; border: 2px solid gold; box-shadow: 0 0 50px rgba(212, 175, 55, 0.3); width: 90%; max-width: 400px; position: relative; z-index: 2100; }
        .gold-title { font-size: 2.5rem; font-weight: bold; background: linear-gradient(to bottom, #fff, #d4af37); -webkit-background-clip: text; -webkit-text-fill-color: transparent; filter: drop-shadow(0 0 10px gold); margin-bottom: 15px; }
        .confetti { position: absolute; width: 10px; height: 10px; background: gold; animation: fall 3s linear infinite; }
        @keyframes fall { to { transform: translateY(100vh) rotate(360deg); } }

        #modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 100; padding: 15px; box-sizing: border-box; overflow-y: auto; }
        #view-container { width: 100%; aspect-ratio: 1/1; background: #000; border-radius: 15px; overflow: hidden; margin: 10px 0; border: 2px solid #334155; position: relative; }
        video, canvas { width: 100%; height: 100%; object-fit: cover; position: absolute; top: 0; left: 0; }
        
        /* ÁîªÂÉèË°®Á§∫Áî®„ÅÆ„Ç≥„É≥„ÉÜ„Éä */
        #riddle-display-area { width: 100%; height: 350px; background: #111; border-radius: 10px; margin-bottom: 10px; overflow: hidden; display: flex; justify-content: center; align-items: center; border: 1px solid #334155; }
        #riddle-image { max-width: 100%; max-height: 100%; object-fit: contain; }

        button { border: none; border-radius: 10px; padding: 14px; font-weight: bold; cursor: pointer; width: 100%; font-size: 1rem; margin-top: 10px; }
        .btn-target { background: #1e293b; color: white; border: 1px solid #4facfe; font-size: 0.8rem; padding: 10px; margin-bottom: 5px; border-radius: 8px; width: 100%; }
        .btn-target:active { background: #4facfe; color: black; }
    </style>
</head>
<body>

    <h2 style="margin: 10px 0;">BINGO MYSTERY AI</h2>

    <div class="setup-section">
        <input type="password" id="test-api-key" placeholder="Gemini API„Ç≠„Éº„ÇíÂÖ•Âäõ">
    </div>

    <div class="item-inventory">
        <div>
            <span style="font-size: 0.6rem; color: gold; display: block;">ITEM: „Éû„Çπ„Çø„Éº„Ç≠„Éº</span>
            <span id="item-count" style="font-size: 1.2rem; font-weight: bold;">0</span>
        </div>
        <button id="use-item-btn" class="item-btn" onclick="toggleItemMode()">„Ç¢„Ç§„ÉÜ„É†„Çí‰Ωø„ÅÜ</button>
    </div>

    <div class="bingo-grid" id="bingo-board"></div>

    <button style="background:none; color:#444; border:none; font-size:0.6rem; margin: 20px 0;" onclick="resetGame()">ÈÄ≤Êçó„Çí„É™„Çª„ÉÉ„Éà„Åó„Å¶ÊúÄÂàù„Åã„Çâ</button>

    <div id="clear-overlay">
        <div id="confetti-container"></div>
        <div class="clear-card">
            <div id="clear-title" class="gold-title">FINISH</div>
            <p id="clear-msg" style="line-height: 1.6; margin-bottom: 20px;"></p>
            <div id="hint-box" style="display:none; color: gold; font-size: 0.8rem; border-top: 1px solid #444; padding-top: 15px; margin-bottom: 15px;"></div>
            <button id="close-finale-btn" style="background:#fff; color:#000;" onclick="closeFinale()">Ê¨°„Å∏</button>
        </div>
    </div>

    <div id="bingo-overlay" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:1500; flex-direction:column; justify-content:center; align-items:center; pointer-events:none;">
        <div style="font-size:4rem; font-weight:bold; color:gold;">BINGO!</div>
    </div>

    <div id="modal">
        <div class="modal-content" style="max-width: 400px; margin: auto;">
            <h2 id="modal-title" style="color:#4facfe; margin:0 0 10px 0;">TARGET</h2>
            
            <div id="capture-section">
                <div id="view-container"><video id="video" autoplay playsinline></video><canvas id="canvas"></canvas></div>
                <button style="background:#4facfe; color:white; width:100%; padding:15px; border-radius:10px;" onclick="analyzeSpot()">üì∏ ÊíÆÂΩ±„Åó„Å¶„ÄåÈñãÊîæ„Äç„Åô„Çã</button>
            </div>

            <div id="riddle-section" style="display:none;" class="input-group">
                <div id="riddle-display-area">
                    <img id="riddle-image" src="" alt="Mystery Riddle">
                </div>
                <input type="text" id="answer-input" style="width:100%; padding:12px; border-radius:8px; background:#1e293b; color:white; border:1px solid #475569; box-sizing:border-box;" placeholder="Á≠î„Åà„ÇíÂÖ•Âäõ">
                <button id="check-ans-btn" style="background:#fbbf24; color:black; width:100%;" onclick="verifyAnswer()">Ê≠£Ëß£Âà§ÂÆö„Åô„Çã</button>
                
                <div id="target-selection-area" style="display:none; margin-top:20px; border-top:1px solid #444; padding-top:15px;">
                    <label id="selection-label" style="display:block; font-size:0.8rem; color:#4facfe; margin-bottom:10px;">Á©∫„Åë„Çã„Éû„Çπ„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºö</label>
                    <div id="target-list"></div>
                </div>
            </div>
            
            <button style="background:#334155; color:white; width:100%; margin-top:10px;" onclick="closeModal()">Êàª„Çã</button>
        </div>
    </div>

    <script>
        const DEFAULT_DATA = [
            { id: 0, color: 'blue', target: "„Çª„Éñ„É≥„Ç§„É¨„Éñ„É≥", riddle:"images/1.png", answer: "„Ç≠„É™„É≥", trueAnswer: "„Ç≠„É™„É≥", identified: false, solved: false, riddleCleared: false, clearsId: 5 },
            { id: 1, color: 'red', target: "‰ªªÂ§©Â†Ç", riddle: "images/2.png", answer: ["‰∫¨ÈÉΩ","‰∫¨ÈÉΩÂ∫ú","kyotofu"], trueAnswer: "‰∫¨ÈÉΩ", identified: false, solved: false, riddleCleared: false, clearsId: 0 },
            { id: 2, color: 'yellow', target: "„Çª„Ç¨", riddle: "images/3.png", answer: "„Ç¨„Çª", trueAnswer: "„Ç¨„Çª", identified: false, solved: false, riddleCleared: false, clearsId: 10 },
            { id: 3, color: 'green', target: "„É¶„Éã„ÇØ„É≠", riddle: "images/4.png", answer: "Ëµ§", trueAnswer: "Ëµ§", identified: false, solved: false, riddleCleared: false, clearsId: 15 },
            { id: 4, color: 'yellow', target: "„É≠„Éº„ÇΩ„É≥", riddle: "images/5.png", answer: "Ë´ñ‰∫â", trueAnswer: "Ë´ñ‰∫â", identified: false, solved: false, riddleCleared: false, clearsId: 1 },
            { id: 5, color: 'red', target: "Èõ™Âç∞„É°„Ç∞„Éü„É´„ÇØ", riddle: "images/6.png", answer: "ÂåóÊµ∑ÈÅì", trueAnswer: "ÂåóÊµ∑ÈÅì", identified: false, solved: false, riddleCleared: false, clearsId: 12 },
            { id: 6, color: 'blue', target: "„Éü„Çπ„Çø„Éº„Éâ„Éº„Éä„ÉÑ", riddle: "images/7.png", answer: "lion", trueAnswer: "lion", identified: false, solved: false, riddleCleared: false, clearsId: 3 },
            { id: 7, color: 'red', target: "„Çπ„Çø„Éº„Éê„ÉÉ„ÇØ„Çπ", riddle: "images/8.png", answer: "„Ç∑„Ç¢„Éà„É´", trueAnswer: "„Ç∑„Ç¢„Éà„É´", identified: false, solved: false, riddleCleared: false, clearsId: 6 },
            { id: 8, color: 'yellow', target: "„Åô„ÅçÂÆ∂", riddle: "images/9.png", answer: "„Åô„ÇÑ„Åç", trueAnswer: "„Åô„ÇÑ„Åç", identified: false, solved: false, riddleCleared: false, clearsId: 2 },
            { id: 9, color: 'green', target: "„Ç§„Ç™„É≥", riddle: "images/10.png", answer: "Á¥´", trueAnswer: "Á¥´", identified: false, solved: false, riddleCleared: false, clearsId: 13 },
            { id: 10, color: 'green', target: "„Éû„ÉÑ„É¢„Éà„Ç≠„É®„Ç∑", riddle: "images/11.png", answer: "„Éû„ÉÑ„Ç≠„É®", trueAnswer: "ÈªÑËâ≤", identified: false, solved: false, riddleCleared: false, clearsId: 4 },
            { id: 11, color: 'red', target: "‰∏∏‰∫ÄË£ΩÈ∫∫", riddle: "images/12.png", answer: "marugame", trueAnswer: "È¶ôÂ∑ù", identified: false, solved: false, riddleCleared: false, clearsId: 14 },
            { id: 12, color: 'green', target: "„Éã„Éà„É™", riddle: "images/13.png", answer: "Á∑ë", trueAnswer: "Á∑ë", identified: false, solved: false, riddleCleared: false, clearsId: 7 },
            { id: 13, color: 'blue', target: "Âë≥„ÅÆÁ¥†", riddle: "images/14.png", answer: "„Éë„É≥„ÉÄ", trueAnswer: "„Éë„É≥„ÉÄ", identified: false, solved: false, riddleCleared: false, clearsId: 8 },
            { id: 14, color: 'blue', target: "„Åü„Åã„Çâ„Åè„Åò", riddle: "images/15.png", answer: "„Åü„Åã„Çâ„Åè„Åò", trueAnswer: "„Åè„Åò„Çâ", identified: false, solved: false, riddleCleared: false, clearsId: 11 },
            { id: 15, color: 'yellow', target: "„Ç≥„ÇØ„É®", riddle: "images/16.png", answer: "„Ç≥„ÇØ„É®", trueAnswer: "‰∫àÂëä", identified: false, solved: false, riddleCleared: false, clearsId: 9 }
        ];

        let MASTER = []; let route = 'none'; let items = 10; let lines = []; let current = null; let itemMode = false; let finaleSeen = false;

        function load() {
            const saved = localStorage.getItem('bingo_grand_v8_save');
            if(saved) {
                const d = JSON.parse(saved); MASTER = d.m; route = d.r; items = d.i; lines = d.l; finaleSeen = d.f || false;
            } else { MASTER = JSON.parse(JSON.stringify(DEFAULT_DATA)); }
            render(); updateUI();
            if(MASTER.every(c => c.solved) && !finaleSeen) showFinale();
        }

        function save() { 
            localStorage.setItem('bingo_grand_v8_save', JSON.stringify({ m: MASTER, r: route, i: items, l: lines, f: finaleSeen })); 
            if(MASTER.every(c => c.solved) && !finaleSeen) showFinale();
        }

        function render() {
            const board = document.getElementById("bingo-board"); board.innerHTML = "";
            MASTER.forEach((d, i) => {
                const cell = document.createElement("div"); cell.className = `cell col-${d.color}`;
                if(d.identified) cell.classList.add("identified");
                if(d.solved) cell.classList.add("complete");
                let ans = (route === 'cross') ? d.trueAnswer : (Array.isArray(d.answer) ? d.answer[0] : d.answer);
                cell.innerHTML = `<span>${d.target}</span>` + (d.riddleCleared ? `<div class="ans-label">Á≠î: ${ans}</div>` : "");
                cell.onclick = () => itemMode ? useItem(i) : openModal(i);
                board.appendChild(cell);
            });
        }

        function updateUI() {
            document.getElementById("item-count").innerText = items;
            const b = document.getElementById("use-item-btn"); b.disabled = items <= 0;
            b.innerText = itemMode ? "CANCEL" : "ITEM USE"; b.style.background = itemMode ? "#ef4444" : "";
        }

        function toggleItemMode() { itemMode = !itemMode; updateUI(); }

        function useItem(i) {
            if(MASTER[i].identified || MASTER[i].solved) return;
            items--; MASTER[i].identified = true; itemMode = false; save(); updateUI(); render(); openModal(i);
        }

        async function openModal(i) {
            current = i; const d = MASTER[i];
            document.getElementById("modal-title").innerText = d.target; document.getElementById("modal").style.display = "block";
            document.getElementById("target-selection-area").style.display = "none"; document.getElementById("check-ans-btn").disabled = false;
            document.getElementById("answer-input").value = "";

            if(d.identified) {
                document.getElementById("capture-section").style.display = "none"; document.getElementById("riddle-section").style.display = "block";
                // PNGÁîªÂÉè„ÇíË°®Á§∫
                document.getElementById("riddle-image").src = d.riddle;
            } else {
                document.getElementById("capture-section").style.display = "block"; document.getElementById("riddle-section").style.display = "none";
                document.getElementById("video").style.display = "block"; document.getElementById("canvas").style.display = "none";
                try { const s = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } }); document.getElementById("video").srcObject = s; } catch(e) { alert("Camera Error"); }
            }
        }

        async function analyzeSpot() {
            const k = document.getElementById("test-api-key").value; if(!k) return alert("API Key Required");
            const v = document.getElementById("video"); const c = document.getElementById("canvas");
            c.width = v.videoWidth; c.height = v.videoHeight; c.getContext("2d").drawImage(v, 0, 0);
            v.style.display = "none"; c.style.display = "block";
            const img = c.toDataURL("image/jpeg", 0.7).split(",")[1];
            try {
                const r = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${k}`, {
                    method: 'POST', body: JSON.stringify({ contents: [{ parts: [{ text: `Is "${MASTER[current].target}" here? YES/NO.` }, { inline_data: { mime_type: "image/jpeg", data: img } }] }] })
                });
                const res = await r.json();
                if(res.candidates[0].content.parts[0].text.toUpperCase().includes("YES")) {
                    MASTER[current].identified = true; save();
                    document.getElementById("capture-section").style.display = "none"; document.getElementById("riddle-section").style.display = "block";
                    document.getElementById("riddle-image").src = MASTER[current].riddle;
                } else { v.style.display = "block"; c.style.display = "none"; alert("Âà§ÂÆöÂ§±Êïó: ÂØæË±°„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì"); }
            } catch(e) { alert("AI Error"); }
        }

        function verifyAnswer() {
            const input = document.getElementById("answer-input").value.trim();
            const d = MASTER[current];
            const okN = Array.isArray(d.answer) ? d.answer.includes(input) : (input === d.answer);
            const okT = (input === d.trueAnswer);
            
            if(route === 'self' && !okN) return alert("‰∏çÊ≠£Ëß£");
            if(route === 'cross' && !okT) return alert("‰∏çÊ≠£Ëß£");
            if(route === 'none' && !okN && !okT) return alert("‰∏çÊ≠£Ëß£");

            document.getElementById("check-ans-btn").disabled = true;
            document.getElementById("target-selection-area").style.display = "block";
            renderTargetButtons(okN, okT);
        }

        function renderTargetButtons(okN, okT) {
            const list = document.getElementById("target-list"); list.innerHTML = "";
            MASTER.forEach((m, idx) => {
                if(!m.solved && m.identified) {
                    const btn = document.createElement("button");
                    btn.className = "btn-target";
                    btn.innerText = `„Éû„Çπ${idx+1}: ${m.target}`;
                    btn.onclick = () => finalize(idx, okN, okT);
                    list.appendChild(btn);
                }
            });
            if(list.innerHTML === "") document.getElementById("selection-label").innerText = "ÈñãÊîæ„Åï„Çå„Å¶„ÅÑ„ÇãÁ©∫„Åç„Éû„Çπ„Åå„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ";
        }

        function finalize(targetIdx, okN, okT) {
            const currentCell = MASTER[current];
            const isSelfChoice = (targetIdx === current);
            const isCrossChoice = (targetIdx === currentCell.clearsId);

            if(route === 'self' && !isSelfChoice) return alert("ÂØæË±°„Éû„Çπ„Åß„ÅØ„Å™„ÅÑ„Åß„Åô„ÄÇ");
            if(route === 'cross' && !isCrossChoice) return alert("ÂØæË±°„Éû„Çπ„Åß„ÅØ„Å™„ÅÑ„Åß„Åô„ÄÇ");
            
            if(route === 'none') {
                if(isSelfChoice && okN) { route = 'self'; } 
                else if(isCrossChoice && okT) { route = 'cross'; alert("„ÄêÁúü„Ç®„É≥„Éâ„É´„Éº„ÉàÁ¢∫ÂÆö„Äë"); } 
                else { return alert("ÂØæË±°„Éû„Çπ„Åæ„Åü„ÅØËß£Á≠î„Åå‰∏ÄËá¥„Åó„Åæ„Åõ„Çì„ÄÇ"); }
            }

            alert("Ê≠£Ëß£ÔºÅ„Éû„Çπ„ÅåÁ©∫„Åç„Åæ„Åó„Åü„ÄÇ");
            MASTER[current].riddleCleared = true;
            MASTER[targetIdx].solved = true;
            save(); checkBingo(); closeModal(); render();
        }

        function checkBingo() {
            const p = [[0,1,2,3],[4,5,6,7],[8,9,10,11],[12,13,14,15],[0,4,8,12],[1,5,9,13],[2,6,10,14],[3,7,11,15],[0,5,10,15],[3,6,9,12]];
            let hit = false;
            p.forEach((line, i) => { if(line.every(idx => MASTER[idx].solved) && !lines.includes(i)) { lines.push(i); items++; hit = true; } });
            if(hit) { document.getElementById("bingo-overlay").style.display = "flex"; setTimeout(()=>document.getElementById("bingo-overlay").style.display="none", 2500); updateUI(); }
        }

        function showFinale() {
            const overlay = document.getElementById("clear-overlay");
            const title = document.getElementById("clear-title");
            const msg = document.getElementById("clear-msg");
            const hint = document.getElementById("hint-box");
            overlay.style.display = "flex";
            if(route === 'self') {
                title.innerText = "NORMAL END";
                msg.innerText = "„Åô„Åπ„Å¶„ÇíËá™ÂàÜËá™Ë∫´„ÅßÂüã„ÇÅ„Åæ„Åó„Åü„ÄÇ";
                hint.style.display = "block";
                hint.innerText = "„Äê„Éí„É≥„Éà„ÄëÊúÄÂàù„ÅÆ‰∏ÄÊâã„Åß„ÄåÂà•„ÅÆÊ≠£Ëß£„Äç„ÇíÊâì„Å°Ëæº„Åø„ÄÅ„É™„É≥„ÇØ„Åô„ÇãÂà•„ÅÆ„Éû„Çπ„ÇíÈÅ∏Êäû„Åó„Å¶„Åø„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ";
            } else {
                title.innerHTML = "TRUE ENDING";
                msg.innerText = "ÈÄ£Èéñ„ÅÆË¨é„ÇíËß£„ÅçÊòé„Åã„Åó„ÄÅÁúüÂÆü„ÅÆÁ≠î„Åà„Å´Ëæø„ÇäÁùÄ„Åç„Åæ„Åó„ÅüÔºÅ";
                createConfetti();
            }
        }

        function closeFinale() {
            if(route === 'self') {
                MASTER.forEach(d => { d.identified = true; d.solved = false; d.riddleCleared = false; });
                route = 'none'; items = 0; lines = []; finaleSeen = false;
            } else { finaleSeen = true; }
            save(); document.getElementById("clear-overlay").style.display = "none"; render();
        }

        function createConfetti() {
            const container = document.getElementById("confetti-container"); container.innerHTML = "";
            for(let i=0; i<60; i++) {
                const c = document.createElement("div"); c.className = "confetti";
                c.style.left = Math.random() * 100 + "vw"; c.style.animationDelay = Math.random() * 3 + "s";
                c.style.backgroundColor = ["#ffd700", "#ffffff", "#ffcc00"][Math.floor(Math.random()*3)];
                container.appendChild(c);
            }
        }

        function closeModal() {
            const v = document.getElementById("video"); if(v.srcObject) v.srcObject.getTracks().forEach(t=>t.stop());
            document.getElementById("riddle-image").src = "";
            document.getElementById("modal").style.display = "none"; render();
        }

        function resetGame() { if(confirm("ÂÆåÂÖ®„Å´Ê∂àÂéª„Åó„Å¶ÊúÄÂàù„Åã„Çâ„ÇÑ„ÇäÁõ¥„Åó„Åæ„Åô„ÅãÔºü")) { localStorage.clear(); location.reload(); } }

        load();
    </script>
</body>
</html>
