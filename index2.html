<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BINGO MYSTERY - Fate Choice</title>
    <style>
        :root { --bg: #0f172a; --glass: rgba(255, 255, 255, 0.1); }
        .col-red { --theme: #ff4d4d; } .col-blue { --theme: #4d94ff; } .col-green { --theme: #2ecc71; } .col-yellow { --theme: #f1c40f; }

        body { font-family: sans-serif; background: var(--bg); color: white; margin: 0; padding: 10px; display: flex; flex-direction: column; align-items: center; min-height: 100vh; }
        
        .setup-section { width: 95%; max-width: 400px; background: var(--glass); padding: 10px; border-radius: 12px; margin-bottom: 10px; border: 1px dashed #4facfe; box-sizing: border-box; }
        .setup-section input { width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #334155; background: #000; color: #fff; box-sizing: border-box; }

        .bingo-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; width: 100%; max-width: 400px; margin-bottom: 20px; }
        .cell { 
            aspect-ratio: 1/1; background: var(--glass); border: 2px solid var(--theme); border-radius: 10px; 
            display: flex; flex-direction: column; justify-content: center; align-items: center; 
            font-size: 0.6rem; font-weight: bold; text-align: center; cursor: pointer; padding: 5px; box-sizing: border-box; color: var(--theme);
        }
        .cell.identified { background: rgba(255, 255, 255, 0.05); box-shadow: inset 0 0 10px var(--theme); color: #fff; } 
        .cell.complete { background: var(--theme); color: #000; border: none; box-shadow: 0 0 15px var(--theme); }
        .ans-label { font-size: 0.5rem; margin-top: 4px; border-top: 1px solid rgba(0,0,0,0.2); width: 100%; padding-top: 2px; }

        /* „ÇØ„É™„Ç¢ÁîªÈù¢ */
        #game-clear-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 2000; flex-direction: column; justify-content: center; align-items: center; text-align: center; padding: 20px; }
        .clear-title { font-size: 2.5rem; font-weight: bold; margin-bottom: 20px; }
        .hint-box { color: gold; font-size: 0.8rem; margin-top: 20px; border: 1px solid gold; padding: 15px; border-radius: 10px; line-height: 1.5; }

        /* „É¢„Éº„ÉÄ„É´ */
        #modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 100; padding: 20px; box-sizing: border-box; overflow-y: auto; }
        .modal-content { max-width: 400px; margin: 0 auto; }
        .input-group { background: rgba(255,255,255,0.05); padding: 15px; border-radius: 15px; margin-bottom: 15px; border: 1px solid rgba(255,255,255,0.1); }
        #view-container { width: 100%; aspect-ratio: 1/1; background: #000; border-radius: 12px; overflow: hidden; margin: 10px 0; border: 2px solid #334155; position: relative; }
        video, canvas { width: 100%; height: 100%; object-fit: cover; position: absolute; top: 0; left: 0; }
        
        button { border: none; border-radius: 10px; padding: 14px; font-weight: bold; cursor: pointer; width: 100%; font-size: 1rem; margin-top: 10px; }
        .btn-solve { background: #fbbf24; color: #000; }
        .btn-target { background: #1e293b; color: white; border: 1px solid #4facfe; font-size: 0.8rem; padding: 10px; }
        .btn-close { background: #334155; color: white; }
        .input-text { width: 100%; padding: 12px; border-radius: 8px; border: 1px solid #475569; background: #1e293b; color: white; box-sizing: border-box; margin-top: 10px; }
    </style>
</head>
<body>

    <h2 style="margin: 10px 0;">BINGO MYSTERY AI</h2>

    <div class="setup-section">
        <input type="password" id="test-api-key" placeholder="Gemini API„Ç≠„Éº„ÇíÂÖ•Âäõ">
    </div>

    <div class="bingo-grid" id="bingo-board"></div>

    <button style="background:#222; color:#555; font-size:0.6rem; padding:5px; border-radius:5px;" onclick="resetGame()">RESET PROGRESS</button>

    <div id="game-clear-overlay">
        <div id="clear-type-title" class="clear-title">FINISH</div>
        <p id="clear-message" style="color:white;"></p>
        <div id="route-hint" class="hint-box" style="display:none;"></div>
        <button class="btn-solve" style="width:200px; margin-top:30px;" onclick="location.reload()">RETRY</button>
    </div>

    <div id="modal">
        <div class="modal-content">
            <h2 id="modal-title" style="color:#4facfe; margin:0 0 10px 0;">TARGET</h2>
            
            <div id="capture-section">
                <div id="view-container">
                    <video id="video" autoplay playsinline></video>
                    <canvas id="canvas"></canvas>
                </div>
                <button style="background:#4facfe; color:white;" onclick="analyzeSpot()">üì∏ ÊíÆÂΩ±„Åó„Å¶„ÄåÈñãÊîæ„Äç„Åô„Çã</button>
            </div>
            
            <div id="riddle-section" style="display:none;" class="input-group">
                <div id="route-lock-msg" style="color:gold; font-size:0.7rem; margin-bottom:10px; font-weight:bold; display:none;">‚ö†Ô∏è „É´„Éº„Éà„ÅåÂõ∫ÂÆö„Åï„Çå„Å¶„ÅÑ„Åæ„Åô</div>
                <div style="color:#fbbf24; font-size:0.8rem; font-weight:bold;">MISSION: Ë¨é„ÇíËß£„Åë</div>
                <p id="riddle-text" style="line-height: 1.6; margin: 10px 0;"></p>
                <input type="text" id="answer-input" class="input-text" placeholder="Á≠î„Åà„ÇíÂÖ•Âäõ">
                <button id="check-ans-btn" class="btn-solve" onclick="verifyAnswer()">Ê≠£Ëß£Âà§ÂÆö„Åô„Çã</button>

                <div id="target-selection-area" style="display:none; margin-top:20px; border-top:1px solid #444; padding-top:15px;">
                    <label style="display:block; font-size:0.8rem; color:#4facfe;">Á©∫„Åë„ÇãÂØæË±°„ÅÆ„Éû„Çπ„ÇíÈÅ∏„Çì„Åß„Åè„Å†„Åï„ÅÑÔºö</label>
                    <div id="target-list"></div>
                </div>
            </div>
            <button class="btn-close" onclick="closeModal()">Êàª„Çã</button>
        </div>
    </div>

    <script>
        /**
         * ‚òÖÈÄ£Èéñ(clearsId)„ÅÆËá™Áî±Ë®≠ÂÆö
         * clearsId: „Åù„ÅÆ„Éû„Çπ„ÅÆË¨é„ÇíËß£„ÅÑ„ÅüÈöõ„ÄÅÈÄ£Èéñ„É´„Éº„Éà„Åß„ÄåÁ©∫„Åè„Äç„Éû„Çπ„ÅÆID
         */
        const DEFAULT_BINGO_DATA = [
            { id: 0, target: "„Çª„Éñ„É≥„Ç§„É¨„Éñ„É≥", riddle: "„ÄåÊúù„ÅØ4Êú¨„ÄÅÊòº„ÅØ2Êú¨„ÄÅÂ§ú„ÅØ3Êú¨„Äç„Åï„Å¶‰ΩïÔºü", answer: "‰∫∫Èñì", identified: false, solved: false, clearsId: 1 },
            { id: 1, target: "‰ªªÂ§©Â†Ç", riddle: "„Éû„É™„Ç™„ÅÆÂ∏ΩÂ≠ê„ÅÆ„Éû„Éº„ÇØ„ÅØÔºü", answer: "M", identified: false, solved: false, clearsId: 2 },
            { id: 2, target: "„Éá„Ç£„Ç∫„Éã„Éº", riddle: "„Éü„ÉÉ„Ç≠„Éº„ÅÆË™ïÁîüÊó•„ÅØ11Êúà‰ΩïÊó•Ôºü", answer: "18", identified: false, solved: false, clearsId: 3 },
            { id: 3, target: "„Éï„Ç°„Éü„Éû", riddle: "„Äå„ÅÇ„Å™„Åü„Å®„Ç≥„É≥„Éì„Å´„Äç„ÅÆÁ∂ö„Åç„ÅØÔºü", answer: "„Éï„Ç°„Éü„É™„Éº„Éû„Éº„Éà", identified: false, solved: false, clearsId: 0 },
            { id: 4, target: "„É≠„Éº„ÇΩ„É≥", riddle: "„Éü„É´„ÇØÁº∂„ÅÆËâ≤„ÅØÔºü", answer: "ÁôΩ", identified: false, solved: false, clearsId: 5 },
            { id: 5, target: "„Éû„ÇØ„Éâ„Éä„É´„Éâ", riddle: "„Éù„ÉÜ„ÉàM„ÅÆÁõÆÂÆâgÊï∞„ÅØÔºü", answer: "135", identified: false, solved: false, clearsId: 4 },
            { id: 6, target: "ÈÉµ‰æøÂ±Ä", riddle: "ÈÉµ‰æø„Éû„Éº„ÇØ„ÅÆÁî±Êù•„ÅØÔºü", answer: "„ÉÜ", identified: false, solved: false, clearsId: 7 },
            { id: 7, target: "„Çπ„Çø„Éê", riddle: "‰∫∫È≠ö„ÅÆÂêçÂâç„ÅØÔºü", answer: "„Çµ„Ç§„É¨„É≥", identified: false, solved: false, clearsId: 6 },
            { id: 8, target: "„ÉÄ„Ç§„ÇΩ„Éº", riddle: "Á§æÂêç„ÅÆÁî±Êù•„ÅØ„ÄåÂ§ß„Åç„Åè‚óè‚óè„Çã„Äç", answer: "Ââµ„Çã", identified: false, solved: false, clearsId: 9 },
            { id: 9, target: "„É¶„Éã„ÇØ„É≠", riddle: "Ê≠£ÂºèÂêçÁß∞„ÅÆÊúÄÂæå„ÅØÔºü", answer: "„Ç¶„Çß„Ç¢", identified: false, solved: false, clearsId: 8 },
            { id: 10, target: "„Åè„ÇâÂØøÂè∏", riddle: "5Áöø„Åß„Åß„Åç„Çã„Ç≤„Éº„É†„ÅØÔºü", answer: "„Éì„ÉÉ„Åè„Çâ„Éù„É≥", identified: false, solved: false, clearsId: 11 },
            { id: 11, target: "ÂêâÈáéÂÆ∂", riddle: "Áâõ„ÅÆËßí„ÅÆÈñì„Å´„ÅÇ„Çã„ÇÇ„ÅÆ„ÅØÔºü", answer: "„Å≤„Çá„ÅÜ„Åü„Çì", identified: false, solved: false, clearsId: 10 },
            { id: 12, target: "„Éã„Éà„É™", riddle: "„Åä„ÄÅ„Å≠„Å†„Çì‚óè‚óè‚óè", answer: "‰ª•‰∏ä", identified: false, solved: false, clearsId: 13 },
            { id: 13, target: "„Ç§„Ç™„É≥", riddle: "ÊóßÁ§æÂêç„ÅØÔºü", answer: "„Ç∏„É£„Çπ„Ç≥", identified: false, solved: false, clearsId: 12 },
            { id: 14, target: "„Ç¨„Çπ„Éà", riddle: "ÁúãÊùø„ÅÆËµ§„ÅÑÈ≥•„ÄÇÂêçÂâç„ÅØ„ÅÇ„ÇãÔºü„Å™„ÅÑÔºü", answer: "„Å™„ÅÑ", identified: false, solved: false, clearsId: 15 },
            { id: 15, target: "„Ç≥„Ç´„Ç≥„Éº„É©", riddle: "„Çµ„É≥„Çø„ÇíËµ§„Åè„Åó„Åü‰ºöÁ§æ„ÅØÔºü", answer: "„Ç≥„Ç´„Ç≥„Éº„É©", identified: false, solved: false, clearsId: 14 }
        ];

        let BINGO_MASTER = [];
        let gameRoute = 'none'; // 'none', 'self', 'cross'
        let currentIdx = null;

        function loadGame() {
            const saved = localStorage.getItem('bingo_v5_save');
            if(saved) {
                const data = JSON.parse(saved);
                BINGO_MASTER = data.master;
                gameRoute = data.route || 'none';
            } else {
                BINGO_MASTER = JSON.parse(JSON.stringify(DEFAULT_BINGO_DATA));
            }
            renderBoard();
        }

        function saveGame() {
            localStorage.setItem('bingo_v5_save', JSON.stringify({ master: BINGO_MASTER, route: gameRoute }));
            checkAllClear();
        }

        function renderBoard() {
            const board = document.getElementById("bingo-board");
            board.innerHTML = "";
            const colors = ['col-red', 'col-blue', 'col-green', 'col-yellow'];
            BINGO_MASTER.forEach((d, i) => {
                const cell = document.createElement("div");
                cell.className = `cell ${colors[i % 4]}`;
                if (d.identified) cell.classList.add("identified");
                if (d.solved) cell.classList.add("complete");
                cell.innerHTML = `<span>${d.target}</span>`;
                cell.onclick = () => openModal(i);
                board.appendChild(cell);
            });
        }

        async function openModal(i) {
            currentIdx = i;
            const data = BINGO_MASTER[i];
            document.getElementById("modal-title").innerText = data.target;
            document.getElementById("modal").style.display = "block";
            document.getElementById("target-selection-area").style.display = "none";
            document.getElementById("check-ans-btn").disabled = false;
            document.getElementById("route-lock-msg").style.display = (gameRoute !== 'none') ? 'block' : 'none';

            if(data.identified) {
                document.getElementById("capture-section").style.display = "none";
                document.getElementById("riddle-section").style.display = "block";
                document.getElementById("riddle-text").innerText = data.riddle;
                document.getElementById("answer-input").value = "";
            } else {
                document.getElementById("capture-section").style.display = "block";
                document.getElementById("riddle-section").style.display = "none";
                document.getElementById("video").style.display = "block";
                document.getElementById("canvas").style.display = "none";
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
                    document.getElementById("video").srcObject = stream;
                } catch (e) { alert("„Ç´„É°„É©‰∏çÂèØ"); }
            }
        }

        async function analyzeSpot() {
            const apiKey = document.getElementById("test-api-key").value.trim();
            const video = document.getElementById("video");
            const canvas = document.getElementById("canvas");
            const data = BINGO_MASTER[currentIdx];
            canvas.width = video.videoWidth; canvas.height = video.videoHeight;
            canvas.getContext("2d").drawImage(video, 0, 0);
            video.style.display = "none"; canvas.style.display = "block";
            const imgBase64 = canvas.toDataURL("image/jpeg", 0.7).split(",")[1];
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
            try {
                const response = await fetch(url, {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: `ÁîªÂÉè„Å´„Äå${data.target}„Äç„Åå„ÅÇ„Çã„Åã„Äå„ÅØ„ÅÑ„Äç„Åã„Äå„ÅÑ„ÅÑ„Åà„Äç„Åß„ÄÇ` }, { inline_data: { mime_type: "image/jpeg", data: imgBase64 } }] }] })
                });
                const res = await response.json();
                if(res.candidates[0].content.parts[0].text.trim().includes("„ÅØ„ÅÑ")) {
                    alert("„Çπ„Ç≠„É£„É≥ÊàêÂäüÔºÅË¨é„ÅåÂá∫Áèæ„Åó„Åæ„Åó„Åü„ÄÇ");
                    data.identified = true; saveGame();
                    document.getElementById("capture-section").style.display = "none";
                    document.getElementById("riddle-section").style.display = "block";
                    document.getElementById("riddle-text").innerText = data.riddle;
                } else { alert("Â§±Êïó"); video.style.display = "block"; canvas.style.display = "none"; }
            } catch (e) { alert("Ëß£Êûê„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ"); }
        }

        // Ë¨éËß£„ÅçËß£Á≠î„Éú„Çø„É≥„ÅÆÂá¶ÁêÜ
        function verifyAnswer() {
            const ansInput = document.getElementById("answer-input").value.trim();
            const currentData = BINGO_MASTER[currentIdx];

            if(ansInput !== currentData.answer) return alert("Á≠î„Åà„ÅåÈÅï„ÅÑ„Åæ„Åô");

            // Ê≠£Ëß£„Åó„Åü„Çâ„Éû„ÇπÈÅ∏Êäû„Ç®„É™„Ç¢„ÇíË°®Á§∫
            document.getElementById("check-ans-btn").disabled = true;
            document.getElementById("target-selection-area").style.display = "block";
            renderTargetList();
        }

        // Á©∫„Åë„ÇãÂØæË±°„ÅÆ„É™„Çπ„Éà„ÇíË°®Á§∫
        function renderTargetList() {
            const listArea = document.getElementById("target-list");
            listArea.innerHTML = "";
            const currentData = BINGO_MASTER[currentIdx];

            BINGO_MASTER.forEach((m, idx) => {
                if(!m.solved) {
                    const isSelf = (idx === currentIdx);
                    const isCross = (idx === currentData.clearsId);

                    // „É´„Éº„Éà„ÅåÊ±∫„Åæ„Å£„Å¶„ÅÑ„Å™„ÅÑ„ÄÅ„Åæ„Åü„ÅØ„É´„Éº„Éà„Å´ÂêàËá¥„Åô„ÇãÈÅ∏ÊäûËÇ¢„ÇíË°®Á§∫
                    if(gameRoute === 'none' || (gameRoute === 'self' && isSelf) || (gameRoute === 'cross' && isCross)) {
                        const btn = document.createElement("button");
                        btn.className = "btn-target";
                        btn.innerText = `„Éû„Çπ${idx+1}: ${m.target}` + (isSelf ? " (Ëá™ÂàÜ)" : "");
                        btn.onclick = () => finalizeChoice(idx);
                        listArea.appendChild(btn);
                    }
                }
            });
        }

        // ÊúÄÁµÇÁöÑ„Å™„É´„Éº„ÉàÁ¢∫ÂÆö„Å®„Éû„ÇπÈñãÊîæ
        function finalizeChoice(targetIdx) {
            const currentData = BINGO_MASTER[currentIdx];
            const isSelfChoice = (targetIdx === currentIdx);
            const isCrossChoice = (targetIdx === currentData.clearsId);

            // 1„Éû„ÇπÁõÆ„Åß„É´„Éº„ÉàÁ¢∫ÂÆö
            if(gameRoute === 'none') {
                gameRoute = isSelfChoice ? 'self' : 'cross';
                alert(gameRoute === 'self' ? "„Äê„Éé„Éº„Éû„É´„É´„Éº„ÉàÁ¢∫ÂÆö„ÄëËá™ÂàÜËá™Ë∫´„ÇíÁ©∫„Åë„ÇãÁâ©Ë™û„ÅåÂßã„Åæ„Çä„Åæ„Åó„Åü„ÄÇ" : "„ÄêÁúü„Ç®„É≥„Éâ„É´„Éº„ÉàÁ¢∫ÂÆö„ÄëÈÄ£Èéñ„ÅÆË¨é„ÇíËß£„ÅçÊòé„Åã„ÅôÈÅì„ÇíÈÅ∏„Å≥„Åæ„Åó„Åü„Å≠„ÄÇ");
            }

            // „É´„Éº„Éà‰∏ç‰∏ÄËá¥„ÉÅ„Çß„ÉÉ„ÇØ
            if(gameRoute === 'self' && !isSelfChoice) return alert("ÂØæË±°„Éû„Çπ„Åß„ÅØ„Å™„ÅÑ„Åß„Åô„ÄÇ");
            if(gameRoute === 'cross' && !isCrossChoice) return alert("ÂØæË±°„Éû„Çπ„Åß„ÅØ„Å™„ÅÑ„Åß„Åô„ÄÇ");

            // ÈñãÊîæ(„Çπ„Ç≠„É£„É≥)„ÉÅ„Çß„ÉÉ„ÇØ
            const targetData = BINGO_MASTER[targetIdx];
            if(!targetData.identified) return alert(`${targetData.target} „Åå„Åæ„Å†ÈñãÊîæ„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„ÇìÔºÅ`);

            alert("Ê≠£Ëß£ÔºÅ„Éû„Çπ„ÅåÂüã„Åæ„Çä„Åæ„Åó„Åü„ÄÇ");
            targetData.solved = true;
            saveGame();
            closeModal();
            renderBoard();
        }

        function checkAllClear() {
            if(BINGO_MASTER.every(d => d.solved)) {
                const overlay = document.getElementById("game-clear-overlay");
                const title = document.getElementById("clear-type-title");
                const msg = document.getElementById("clear-message");
                const hint = document.getElementById("route-hint");
                overlay.style.display = "flex";

                if(gameRoute === 'self') {
                    title.innerText = "NORMAL END";
                    msg.innerText = "„Åô„Åπ„Å¶„ÇíËá™ÂàÜËá™Ë∫´„ÅÆÊâã„ÅßÂüã„ÇÅ„Åæ„Åó„Åü„ÄÇ\nÂπ≥Á©è„Å™„ÇØ„É™„Ç¢„Åß„Åô„ÄÇ";
                    hint.style.display = "block";
                    hint.innerText = "„ÄêÂà•„ÅÆÂèØËÉΩÊÄß„Å∏„ÅÆÁ§∫ÂîÜ„Äë\n„ÅÇ„Å™„Åü„ÅØ„ÄåËá™ÂàÜËá™Ë∫´„Äç‰ª•Â§ñ„ÅÆ„Éû„Çπ„ÇíÁ©∫„Åë„Çã„Åì„Å®„ÇÇ„Åß„Åç„Åü„ÅØ„Åö„Åß„Åô„ÄÇÊúÄÂàù„ÅÆ‰∏ÄÊâã„Åß„ÄåÈÄ£Èéñ„Äç„ÅÆÈÅì„ÇíÈÅ∏„Çì„Åß„ÅÑ„Çå„Å∞„ÄÅÂà•„ÅÆÁúüÂÆü„Å´Ëæø„ÇäÁùÄ„Åë„Åü„Åã„ÇÇ„Åó„Çå„Åæ„Åõ„Çì„ÄÇ";
                } else {
                    title.innerText = "TRUE ENDING";
                    title.style.color = "gold";
                    msg.innerText = "Ë§áÈõë„Å™„Éû„Çπ„ÅÆÈÄ£Èéñ„Çí„Åô„Åπ„Å¶Ëß£„ÅçÊòé„Åã„Åó„Åæ„Åó„ÅüÔºÅ\n„ÅÇ„Å™„Åü„ÅØ‰∏ñÁïå„ÅÆÁπã„Åå„Çä„ÇíÁêÜËß£„Åó„ÅüÁúü„ÅÆÊé¢Á¥¢ËÄÖ„Åß„Åô„ÄÇ";
                }
            }
        }

        function closeModal() {
            const v = document.getElementById("video");
            if (v.srcObject) v.srcObject.getTracks().forEach(t => t.stop());
            document.getElementById("modal").style.display = "none";
        }

        function resetGame() {
            if(confirm("ÂÖ®„Éá„Éº„Çø„ÇíÊ∂àÂéª„Åó„Å¶„É™„Çª„ÉÉ„Éà„Åó„Åæ„Åô„ÅãÔºü")) { localStorage.removeItem('bingo_v5_save'); location.reload(); }
        }

        loadGame();
    </script>
</body>
</html>
