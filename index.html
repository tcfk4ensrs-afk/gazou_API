<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BINGO MYSTERY AI - Flow Fixed</title>
    <style>
        :root { --primary: #00f2fe; --accent: #4facfe; --bg: #0f172a; --glass: rgba(255, 255, 255, 0.1); }
        body { font-family: sans-serif; background: var(--bg); color: white; margin: 0; padding: 10px; display: flex; flex-direction: column; align-items: center; }
        
        .setup-section { width: 95%; max-width: 400px; background: var(--glass); padding: 15px; border-radius: 12px; margin-bottom: 15px; border: 1px dashed var(--accent); box-sizing: border-box; }
        .setup-section input { width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #334155; background: #000; color: #fff; box-sizing: border-box; }

        /* ãƒ¡ã‚¤ãƒ³æ“ä½œã‚¨ãƒªã‚¢ï¼šã¾ãšæ’®å½±ã‹ã‚‰å§‹ã¾ã‚‹ */
        .capture-area { width: 95%; max-width: 400px; background: var(--glass); padding: 15px; border-radius: 15px; border: 1px solid var(--accent); margin-bottom: 20px; box-sizing: border-box; }
        #webcam-container { width: 100%; aspect-ratio: 4/3; background: #000; border-radius: 10px; overflow: hidden; margin-bottom: 10px; border: 2px solid #334155; }
        video { width: 100%; height: 100%; object-fit: cover; }

        /* è¬è§£ãã‚¨ãƒªã‚¢ï¼šèªè­˜æˆåŠŸå¾Œã«è¡¨ç¤º */
        #riddle-area { display: none; width: 95%; max-width: 400px; background: rgba(251, 191, 36, 0.1); padding: 20px; border-radius: 15px; border: 2px solid #fbbf24; margin-bottom: 20px; box-sizing: border-box; animation: fadeIn 0.5s; }

        /* ãƒ“ãƒ³ã‚´ã‚°ãƒªãƒƒãƒ‰ */
        .bingo-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; width: 100%; max-width: 400px; margin-top: 10px; }
        .cell { aspect-ratio: 1/1; background: var(--glass); border: 1px solid rgba(255,255,255,0.1); border-radius: 10px; display: flex; justify-content: center; align-items: center; font-size: 0.6rem; font-weight: bold; text-align: center; position: relative; padding: 5px; box-sizing: border-box; }
        .cell.complete { background: linear-gradient(135deg, var(--primary), var(--accent)); color: #0f172a; border: none; box-shadow: 0 0 15px var(--primary); }

        button { border: none; border-radius: 10px; padding: 14px; font-weight: bold; cursor: pointer; width: 100%; font-size: 1rem; margin-top: 10px; }
        .btn-capture { background: var(--primary); color: #0f172a; }
        .btn-solve { background: #fbbf24; color: #000; }
        .input-text, .select-box { width: 100%; padding: 12px; border-radius: 8px; border: 1px solid #475569; background: #1e293b; color: white; box-sizing: border-box; margin-top: 10px; font-size: 1rem; }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

    <h2 style="margin: 10px 0;">BINGO MYSTERY AI</h2>

    <div class="setup-section">
        <input type="password" id="test-api-key" placeholder="Gemini APIã‚­ãƒ¼ã‚’å…¥åŠ›">
    </div>

    <div class="capture-area">
        <div id="webcam-container">
            <video id="video" autoplay playsinline></video>
            <canvas id="canvas" style="display:none;"></canvas>
        </div>
        <button class="btn-capture" onclick="analyzeSpot()">ğŸ“¸ ã‚¹ãƒãƒƒãƒˆã‚’èªè­˜ã™ã‚‹</button>
        <div id="ai-status" style="font-size:0.75rem; text-align:center; margin-top:8px; color:#94a3b8;">ã¾ãšã¯å¯¾è±¡ç‰©ã‚’æ’®å½±ã—ã¦ãã ã•ã„</div>
    </div>

    <div id="riddle-area">
        <h3 id="detected-name" style="color:#fbbf24; margin:0;">ã‚¿ãƒ¼ã‚²ãƒƒãƒˆç™ºè¦‹ï¼</h3>
        <p id="riddle-text" style="margin: 15px 0;"></p>
        <input type="text" id="answer-input" class="input-text" placeholder="è¬ã®ç­”ãˆã‚’å…¥åŠ›">
        
        <label style="display:block; margin-top:15px; font-size:0.8rem;">é©ç”¨ã™ã‚‹ãƒã‚¹ã‚’é¸æŠï¼š</label>
        <select id="cell-selector" class="select-box">
            </select>
        
        <button class="btn-solve" onclick="finalCheck()">æ­£è§£åˆ¤å®š & ãƒã‚¹ã‚’é–‹ã‘ã‚‹</button>
    </div>

    <div class="bingo-grid" id="bingo-board"></div>

    <script>
        // ãƒ‡ãƒ¼ã‚¿å®šç¾©
        const BINGO_MASTER = [
            { id: 0, target: "ã‚»ãƒ–ãƒ³ã‚¤ãƒ¬ãƒ–ãƒ³", riddle: "ã€Œæœã¯4æœ¬ã€æ˜¼ã¯2æœ¬ã€å¤œã¯3æœ¬ã€ã•ã¦ä½•ã®ç”Ÿãç‰©ï¼Ÿ", answer: "äººé–“" },
            { id: 1, target: "ãƒ•ã‚¡ãƒŸãƒ", riddle: "ã€Œã‚ãªãŸã¨ã‚³ãƒ³ãƒ“ã«ã€ã®ç¶šãã¯ï¼Ÿ", answer: "ãƒ•ã‚¡ãƒŸãƒªãƒ¼ãƒãƒ¼ãƒˆ" },
            { id: 2, target: "ãƒ‡ã‚£ã‚ºãƒ‹ãƒ¼", riddle: "ãƒŸãƒƒã‚­ãƒ¼ã®èª•ç”Ÿæ—¥ã¯11æœˆä½•æ—¥ï¼Ÿ", answer: "18" },
            { id: 3, target: "ä»»å¤©å ‚", riddle: "ãƒãƒªã‚ªã®å¸½å­ã®ãƒãƒ¼ã‚¯ã¯ï¼Ÿ", answer: "M" },
            { id: 4, target: "ãƒã‚¯ãƒ‰ãƒŠãƒ«ãƒ‰", riddle: "Må­—å‹ã®é»„è‰²ã„ãƒ­ã‚´ã®ãƒ¢ãƒ‡ãƒ«ã¨ãªã£ãŸã‚¢ãƒ«ãƒ•ã‚¡ãƒ™ãƒƒãƒˆã¯ï¼Ÿ", answer: "M" },
            { id: 5, target: "ãƒ­ãƒ¼ã‚½ãƒ³", riddle: "ãƒ­ã‚´ã«æã‹ã‚Œã¦ã„ã‚‹ãƒŸãƒ«ã‚¯ç¼¶ã®è‰²ã¯ï¼Ÿ", answer: "ç™½" }
        ];

        // è¶³ã‚Šãªã„åˆ†ã‚’ãƒ€ãƒŸãƒ¼ã§è£œå®Œ
        for(let i=BINGO_MASTER.length; i<16; i++) {
            BINGO_MASTER.push({ id: i, target: `ã‚¹ãƒãƒƒãƒˆ${i+1}`, riddle: "ç­”ãˆã¯ã€Œã‚ã€", answer: "ã‚" });
        }

        let solvedData = null; // ç¾åœ¨èªè­˜ä¸­ã®ã‚¹ãƒãƒƒãƒˆãƒ‡ãƒ¼ã‚¿
        let bingoState = new Array(16).fill(false); // å„ãƒã‚¹ã®ã‚¯ãƒªã‚¢çŠ¶æ…‹

        // ãƒ“ãƒ³ã‚´ãƒœãƒ¼ãƒ‰ã¨ã‚»ãƒ¬ã‚¯ãƒˆãƒœãƒƒã‚¯ã‚¹ã®æç”»
        function renderUI() {
            const board = document.getElementById("bingo-board");
            const selector = document.getElementById("cell-selector");
            board.innerHTML = "";
            selector.innerHTML = '<option value="">â–¼ ãƒã‚¹ã‚’é¸æŠã—ã¦ãã ã•ã„</option>';

            BINGO_MASTER.forEach((d, index) => {
                // ãƒœãƒ¼ãƒ‰æç”»
                const cell = document.createElement("div");
                cell.className = "cell" + (bingoState[index] ? " complete" : "");
                cell.innerHTML = `<span>${d.target}</span>`;
                board.appendChild(cell);

                // ã‚»ãƒ¬ã‚¯ãƒˆãƒœãƒƒã‚¯ã‚¹æç”»ï¼ˆæœªã‚¯ãƒªã‚¢ã®ãƒã‚¹ã®ã¿ï¼‰
                if(!bingoState[index]) {
                    const opt = document.createElement("option");
                    opt.value = index;
                    opt.innerText = `ãƒã‚¹${index + 1}: ${d.target}`;
                    selector.appendChild(opt);
                }
            });
        }

        // ã‚«ãƒ¡ãƒ©èµ·å‹•
        async function startCamera() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
                document.getElementById("video").srcObject = stream;
            } catch (e) { alert("ã‚«ãƒ¡ãƒ©èµ·å‹•å¤±æ•—"); }
        }

        // ã‚¹ãƒ†ãƒƒãƒ—1: ç”»åƒèªè­˜
        async function analyzeSpot() {
            const apiKey = document.getElementById("test-api-key").value.trim();
            if(!apiKey) { alert("APIã‚­ãƒ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"); return; }

            const video = document.getElementById("video");
            const canvas = document.getElementById("canvas");
            const status = document.getElementById("ai-status");

            canvas.width = video.videoWidth; canvas.height = video.videoHeight;
            canvas.getContext("2d").drawImage(video, 0, 0);
            const imgBase64 = canvas.toDataURL("image/jpeg", 0.7).split(",")[1];

            status.innerText = "AIãŒã‚¹ãƒãƒƒãƒˆã‚’åˆ¤å®šä¸­...";

            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
            const targetNames = BINGO_MASTER.map(b => b.target).join(", ");

            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{
                            parts: [
                                { text: `ç”»åƒã«ä½•ãŒå†™ã£ã¦ã„ã‚‹ã‹ä»¥ä¸‹ã®ãƒªã‚¹ãƒˆã‹ã‚‰1ã¤é¸ã‚“ã§åç§°ã®ã¿ç­”ãˆã¦ã€‚ãƒªã‚¹ãƒˆã«ãªã„å ´åˆã¯ã€Œä¸æ˜ã€ã¨ç­”ãˆã¦ã€‚ãƒªã‚¹ãƒˆï¼š[${targetNames}]` },
                                { inline_data: { mime_type: "image/jpeg", data: imgBase64 } }
                            ]
                        }]
                    })
                });
                const res = await response.json();
                const aiResult = res.candidates[0].content.parts[0].text.trim();

                const matched = BINGO_MASTER.find(b => aiResult.includes(b.target));

                if (matched) {
                    solvedData = matched;
                    document.getElementById("detected-name").innerText = `ğŸ¯ ã‚¿ãƒ¼ã‚²ãƒƒãƒˆï¼š${matched.target}`;
                    document.getElementById("riddle-text").innerText = matched.riddle;
                    document.getElementById("riddle-area").style.display = "block";
                    status.innerText = "èªè­˜æˆåŠŸï¼è¬ã‚’è§£ã„ã¦ãã ã•ã„ã€‚";
                    window.scrollTo({ top: document.getElementById("riddle-area").offsetTop, behavior: 'smooth' });
                } else {
                    alert("å¯¾è±¡ç‰©ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚ãƒªã‚¹ãƒˆã«ã‚ã‚‹ã‚‚ã®ã‚’æ˜ ã—ã¦ãã ã•ã„ã€‚");
                    status.innerText = "èªè­˜å¤±æ•—";
                }
            } catch (e) { alert("ã‚¨ãƒ©ãƒ¼: " + e.message); status.innerText = "ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿ"; }
        }

        // ã‚¹ãƒ†ãƒƒãƒ—2: è¬è§£ãæ­£è§£åˆ¤å®š ï¼† ãƒã‚¹é©ç”¨
        function finalCheck() {
            const answer = document.getElementById("answer-input").value.trim();
            const selectedIdx = document.getElementById("cell-selector").value;

            if (!solvedData) return;
            if (selectedIdx === "") { alert("é©ç”¨ã™ã‚‹ãƒã‚¹ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚"); return; }

            // 1. è¬ã®æ­£è§£ãƒã‚§ãƒƒã‚¯
            if (answer !== solvedData.answer) {
                alert("è¬è§£ãã®ç­”ãˆãŒé•ã„ã¾ã™ï¼");
                return;
            }

            // 2. é¸æŠã—ãŸãƒã‚¹ãŒã€ä»Šèªè­˜ã—ãŸã‚¿ãƒ¼ã‚²ãƒƒãƒˆã¨ä¸€è‡´ã™ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
            // â€»ã€Œã©ã®ãƒã‚¹ã«å½“ã¦ã¯ã‚ã‚‹ã‹ã€ã®æˆ¦ç•¥æ€§ã‚’å‡ºã™ãŸã‚ã€ã‚ãˆã¦å³å¯†ã«åˆ¤å®š
            if (BINGO_MASTER[selectedIdx].target !== solvedData.target) {
                alert(`ã“ã®ç­”ãˆã¯ã€Œ${BINGO_MASTER[selectedIdx].target}ã€ã®ãƒã‚¹ã«ã¯é©ç”¨ã§ãã¾ã›ã‚“ï¼`);
                return;
            }

            // ã™ã¹ã¦OKãªã‚‰ã‚¯ãƒªã‚¢
            alert(`æ­£è§£ï¼ ${solvedData.target} ã®ãƒã‚¹ãŒé–‹ãã¾ã—ãŸï¼`);
            bingoState[selectedIdx] = true;
            
            // ãƒªã‚»ãƒƒãƒˆã—ã¦æç”»
            document.getElementById("riddle-area").style.display = "none";
            document.getElementById("answer-input").value = "";
            solvedData = null;
            renderUI();
        }

        // åˆæœŸåŒ–
        renderUI();
        startCamera();
    </script>
</body>
</html>

