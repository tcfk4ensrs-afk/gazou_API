<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Spot Explorer</title>
    <style>
        :root {
            --primary: #00f2fe;
            --accent: #4facfe;
            --success: #00ff88;
            --danger: #ff4b2b;
            --bg: #0f172a;
            --glass: rgba(255, 255, 255, 0.1);
        }

        body {
            font-family: 'Helvetica Neue', Arial, sans-serif;
            margin: 0;
            background: var(--bg);
            color: white;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }

        header { padding: 30px 0 10px; text-align: center; }
        h1 {
            font-size: 1.5rem;
            letter-spacing: 2px;
            text-transform: uppercase;
            background: linear-gradient(to right, var(--primary), var(--accent));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin: 0;
        }

        #status { font-size: 0.8rem; color: #94a3b8; margin-top: 5px; min-height: 1.2em; }

        /* ã‚«ãƒ¡ãƒ©ã‚¨ãƒªã‚¢ */
        #webcam-outer {
            position: relative;
            margin: 20px auto;
            width: 320px;
            height: 320px;
            border-radius: 30px;
            padding: 8px;
            background: linear-gradient(135deg, var(--primary), var(--accent));
            box-shadow: 0 0 30px rgba(79, 172, 254, 0.4);
        }

        #webcam-container {
            width: 100%;
            height: 100%;
            border-radius: 22px;
            overflow: hidden;
            background: #000;
            position: relative;
        }

        video { width: 100%; height: 100%; object-fit: cover; }
        canvas { display: none; }

        /* ã‚¹ã‚­ãƒ£ãƒ³ç·š */
        .scan-line {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 3px;
            background: var(--primary);
            box-shadow: 0 0 15px var(--primary);
            z-index: 10;
            animation: scan 2s linear infinite;
            display: none;
        }
        @keyframes scan { 0% { top: 0; } 100% { top: 100%; } }

        /* ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ« */
        .controls {
            margin: 20px 0;
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
        }

        button {
            border: none; border-radius: 50px; padding: 16px 40px;
            font-size: 1rem; font-weight: bold; color: white;
            cursor: pointer; transition: 0.3s; width: 80%; max-width: 300px;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.3);
        }
        .btn-start { background: linear-gradient(to right, #6a11cb, #2575fc); }
        .btn-capture { background: linear-gradient(to right, #ff416c, #ff4b2b); }
        .btn-reset { background: rgba(255, 255, 255, 0.2); backdrop-filter: blur(10px); }
        button:active { transform: scale(0.95); }

        /* çµæœã‚¨ãƒªã‚¢ */
        .info-card {
            display: none;
            width: 85%; max-width: 400px;
            margin: 10px auto 40px;
            padding: 25px;
            background: var(--glass);
            backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }

        .result-label { font-size: 1.4rem; font-weight: bold; color: var(--primary); margin-bottom: 10px; }
        #result-image { width: 100%; border-radius: 15px; margin: 15px 0; border: 1px solid rgba(255, 255, 255, 0.2); }
        #distance-tag {
            display: inline-block; padding: 5px 12px; background: rgba(0, 255, 136, 0.2);
            color: var(--success); border-radius: 50px; font-size: 0.8rem; margin-top: 10px;
        }
    </style>
</head>
<body>

    <header>
        <h1>Spot Explorer AI</h1>
        <div id="status">ã‚·ã‚¹ãƒ†ãƒ ã‚’èµ·å‹•ã—ã¦ãã ã•ã„</div>
    </header>
    
    <div id="webcam-outer">
        <div id="webcam-container">
            <video id="video" autoplay playsinline></video>
            <canvas id="canvas"></canvas>
            <div id="scan-line" class="scan-line"></div>
        </div>
    </div>

    <div id="info-area" class="info-card">
        <div id="result-label" class="result-label"></div>
        <img id="result-image" style="display: none;">
        <div id="info-desc" style="line-height: 1.6; color: #cbd5e1;"></div>
        <div id="distance-tag"></div>
    </div>

    <div class="controls">
        <button id="start-btn" class="btn-start" onclick="initSystem()">START SYSTEM</button>
        <button id="capture-btn" class="btn-capture" style="display: none;" onclick="analyze()">ğŸ“¸ ANALYSIS (åˆ¤å®š)</button>
        <button id="reset-btn" class="btn-reset" style="display: none;" onclick="location.reload()">RETRY (å†é–‹)</button>
    </div>

    <script>
        // è¨­å®šãƒ‡ãƒ¼ã‚¿
        const TARGETS = {
            "Nintendo": { 
                lat: 35.6586, lon: 139.7454, 
                title: "Nintendo Station", 
                desc: "ç‰¹åˆ¥ãªä»»å¤©å ‚ã‚¹ãƒãƒƒãƒˆã‚’æ¤œçŸ¥ã€‚é™å®šæƒ…å ±ã‚’è¡¨ç¤ºã—ã¾ã™ã€‚",
                image: "nintendo.jpg" 
            },
            "ã‚»ãƒ–ãƒ³ã‚¤ãƒ¬ãƒ–ãƒ³": { 
                lat: 35.6812, lon: 139.7671, 
                title: "7-Eleven Point", 
                desc: "ã‚»ãƒ–ãƒ³ã‚¤ãƒ¬ãƒ–ãƒ³ã‚’èªè­˜ã€‚ã‚¯ãƒ¼ãƒãƒ³ãŒåˆ©ç”¨å¯èƒ½ã§ã™ã€‚",
                image: "711.jpg"
            }
        };

        let userLat, userLon;

        // 1. ã‚·ã‚¹ãƒ†ãƒ èµ·å‹•
        async function initSystem() {
            const status = document.getElementById("status");
            status.innerText = "GPSã‚’å–å¾—ä¸­...";

            navigator.geolocation.getCurrentPosition(async (pos) => {
                userLat = pos.coords.latitude;
                userLon = pos.coords.longitude;

                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
                    document.getElementById("video").srcObject = stream;
                    
                    document.getElementById("start-btn").style.display = "none";
                    document.getElementById("capture-btn").style.display = "block";
                    document.getElementById("scan-line").style.display = "block";
                    status.innerText = "å¯¾è±¡ã‚’æ˜ ã—ã¦åˆ¤å®šãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„";
                } catch (e) {
                    status.innerText = "ã‚«ãƒ¡ãƒ©ã®èµ·å‹•ã«å¤±æ•—ã—ã¾ã—ãŸã€‚";
                }
            }, (err) => {
                status.innerText = "ä½ç½®æƒ…å ±ã‚’è¨±å¯ã—ã¦ãã ã•ã„ã€‚";
            });
        }

        // 2. åˆ¤å®šå‡¦ç†ï¼ˆGemini APIå‘¼ã³å‡ºã—ï¼‰
        async function analyze() {
            const video = document.getElementById("video");
            const status = document.getElementById("status");
            const scanLine = document.getElementById("scan-line");

            // ç”»åƒã‚’ãƒ•ãƒªãƒ¼ã‚ºã•ã›ã‚‹
            video.pause();
            scanLine.style.display = "none";
            status.innerText = "AIè§£æä¸­ï¼ˆã‚µãƒ¼ãƒãƒ¼é€šä¿¡ä¸­ï¼‰...";
            document.getElementById("capture-btn").style.display = "none";

            // ç”»åƒã®è»½é‡åŒ–ï¼ˆãƒªã‚µã‚¤ã‚ºï¼‰
            const canvas = document.getElementById("canvas");
            const scale = Math.min(1, 800 / video.videoWidth); 
            canvas.width = video.videoWidth * scale;
            canvas.height = video.videoHeight * scale;
            const ctx = canvas.getContext("2d");
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            
            // Base64åŒ– (JPEG 70%å“è³ª)
            const base64Image = canvas.toDataURL("image/jpeg", 0.7).split(",")[1];

            try {
                // Netlify Functionsã‚’å‘¼ã³å‡ºã—
                const response = await fetch('/.netlify/functions/analyze', {
                    method: 'POST',
                    body: JSON.stringify({
                        image: base64Image,
                        prompt: "ã“ã®ç”»åƒã«Nintendoã‹ã‚»ãƒ–ãƒ³ã‚¤ãƒ¬ãƒ–ãƒ³ã®çœ‹æ¿ãŒã‚ã‚‹ã‹åˆ¤å®šã—ã¦ã€‚ã‚ã‚Œã°ãã®åå‰ã ã‘è¿”ã—ã¦ã€‚ãªã‘ã‚Œã°Noneã¨è¿”ã—ã¦ã€‚"
                    })
                });

                const data = await response.json();
                if (!response.ok) throw new Error(data.error || "Server Error");

                const resultText = data.candidates[0].content.parts[0].text.trim();

                if (resultText !== "None" && TARGETS[resultText]) {
                    const target = TARGETS[resultText];
                    const dist = calculateDistance(userLat, userLon, target.lat, target.lon);

                    if (dist <= 50) {
                        showResult(target, dist);
                        status.innerText = "åˆ¤å®šæˆåŠŸï¼";
                    } else {
                        status.innerText = "å¯¾è±¡ã¯åˆã£ã¦ã„ã¾ã™ãŒã€å ´æ‰€ãŒé ã™ãã¾ã™ã€‚";
                        showResult({title: resultText, desc: "ã‚‚ã£ã¨è¿‘ãã§æ’®å½±ã—ã¦ãã ã•ã„ã€‚"}, dist, false);
                    }
                } else {
                    status.innerText = "å¯¾è±¡ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚";
                }
            } catch (e) {
                console.error(e);
                status.innerText = "ã‚¨ãƒ©ãƒ¼: " + e.message;
            }
            document.getElementById("reset-btn").style.display = "block";
        }

        // 3. çµæœè¡¨ç¤º
        function showResult(target, dist, success = true) {
            const area = document.getElementById("info-area");
            const img = document.getElementById("result-image");
            area.style.display = "block";
            document.getElementById("result-label").innerText = target.title;
            document.getElementById("info-desc").innerText = target.desc;
            document.getElementById("distance-tag").innerText = `ğŸ“ DISTANCE: ${Math.round(dist)}m`;
            
            if (success && target.image) {
                img.src = target.image;
                img.style.display = "block";
            } else {
                img.style.display = "none";
            }
            area.scrollIntoView({ behavior: 'smooth' });
        }

        // 4. è·é›¢è¨ˆç®—ï¼ˆãƒãƒã‚µã‚¤ãƒ³ï¼‰
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371000;
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat / 2)**2 + Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.sin(dLon / 2)**2;
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
        }
    </script>
</body>
</html>
