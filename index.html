<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BINGO MYSTERY AI (GitHub Pagesç‰ˆ)</title>
    <style>
        :root { --primary: #00f2fe; --accent: #4facfe; --bg: #0f172a; --glass: rgba(255, 255, 255, 0.1); }
        body { font-family: sans-serif; background: var(--bg); color: white; margin: 0; padding: 10px; display: flex; flex-direction: column; align-items: center; }
        
        /* è¨­å®šã‚¨ãƒªã‚¢ */
        .setup-section { width: 95%; max-width: 400px; background: var(--glass); padding: 15px; border-radius: 12px; margin-bottom: 15px; border: 1px dashed var(--accent); box-sizing: border-box; }
        .setup-section label { font-size: 0.7rem; color: var(--accent); display: block; margin-bottom: 5px; text-transform: uppercase; letter-spacing: 1px; }
        .setup-section input { width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #334155; background: #000; color: #fff; box-sizing: border-box; font-size: 0.9rem; }

        /* ãƒ“ãƒ³ã‚´ã‚°ãƒªãƒƒãƒ‰ */
        .bingo-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; width: 100%; max-width: 400px; }
        .cell {
            aspect-ratio: 1/1; background: var(--glass); border: 1px solid rgba(255,255,255,0.1); border-radius: 10px;
            display: flex; justify-content: center; align-items: center; font-size: 0.65rem; font-weight: bold;
            text-align: center; cursor: pointer; position: relative; padding: 5px; box-sizing: border-box; overflow: hidden;
        }
        .cell::before, .cell::after { content: ''; position: absolute; left: 0; height: 4px; width: 0; transition: 0.4s; }
        .cell::before { top: 0; background: #fbbf24; }
        .cell::after { bottom: 0; background: #10b981; }
        .cell.solved-riddle::before { width: 100%; }
        .cell.solved-photo::after { width: 100%; }
        .cell.complete { background: linear-gradient(135deg, var(--primary), var(--accent)); color: #0f172a; border: none; box-shadow: 0 0 15px var(--primary); }

        /* ãƒ¢ãƒ¼ãƒ€ãƒ« */
        #modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 100; padding: 20px; box-sizing: border-box; overflow-y: auto; }
        .modal-content { max-width: 400px; margin: 0 auto; }
        .input-group { background: rgba(255,255,255,0.05); padding: 15px; border-radius: 15px; margin-bottom: 15px; border: 1px solid rgba(255,255,255,0.1); }
        #webcam-container { width: 100%; aspect-ratio: 1/1; background: #000; border-radius: 12px; overflow: hidden; margin: 10px 0; border: 2px solid #334155; }
        video { width: 100%; height: 100%; object-fit: cover; }
        
        button { border: none; border-radius: 10px; padding: 14px; font-weight: bold; cursor: pointer; width: 100%; font-size: 1rem; }
        .btn-main { background: var(--primary); color: #0f172a; margin-top: 10px; }
        .btn-close { background: #334155; color: white; margin-top: 20px; }
        .input-text { width: 100%; padding: 12px; border-radius: 8px; border: 1px solid #475569; background: #1e293b; color: white; box-sizing: border-box; margin-top: 10px; }
    </style>
</head>
<body>

    <h2 style="margin: 10px 0;">BINGO MYSTERY AI</h2>

    <div class="setup-section">
        <label>Set Gemini API Key</label>
        <input type="password" id="test-api-key" placeholder="APIã‚­ãƒ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„">
    </div>

    <div class="bingo-grid" id="bingo-board"></div>

    <div id="modal">
        <div class="modal-content">
            <h2 id="modal-title" style="color:var(--primary); margin:0 0 15px 0;">TARGET</h2>
            
            <div class="input-group">
                <div style="color:#fbbf24; font-size:0.8rem; font-weight:bold;">MISSION 1: RIDDLE</div>
                <p id="riddle-text" style="line-height: 1.6; margin: 10px 0;"></p>
                <input type="text" id="answer-input" class="input-text" placeholder="ç­”ãˆã‚’å…¥åŠ›">
                <button class="btn-main" onclick="checkAnswer()">ç­”ãˆåˆã‚ã›</button>
            </div>

            <div class="input-group">
                <div style="color:#10b981; font-size:0.8rem; font-weight:bold;">MISSION 2: PHOTO</div>
                <div id="webcam-container">
                    <video id="video" autoplay playsinline></video>
                    <canvas id="canvas" style="display:none;"></canvas>
                </div>
                <button id="capture-btn" class="btn-main" onclick="analyze()">ğŸ“¸ æ’®å½±ã—ã¦åˆ¤å®š</button>
                <div id="ai-status" style="font-size:0.75rem; text-align:center; margin-top:8px; color:#94a3b8;">å¯¾è±¡ã‚’æ˜ ã—ã¦ãã ã•ã„</div>
            </div>

            <button class="btn-close" onclick="closeModal()">é–‰ã˜ã‚‹</button>
        </div>
    </div>

    <script>
        const BINGO_DATA = [
            { id: 0, target: "ã‚»ãƒ–ãƒ³ã‚¤ãƒ¬ãƒ–ãƒ³", riddle: "æœã¯4æœ¬ã€æ˜¼ã¯2æœ¬ã€å¤œã¯3æœ¬ã®ç”Ÿãç‰©ã¯ï¼Ÿ", answer: "äººé–“", solvedRiddle: false, solvedPhoto: false },
            { id: 1, target: "ä»»å¤©å ‚", riddle: "ãƒãƒªã‚ªã®å¸½å­ã®ãƒãƒ¼ã‚¯ã¯ï¼Ÿ", answer: "M", solvedRiddle: false, solvedPhoto: false },
            { id: 2, target: "ãƒ‡ã‚£ã‚ºãƒ‹ãƒ¼", riddle: "ãƒŸãƒƒã‚­ãƒ¼ãƒã‚¦ã‚¹ã®èª•ç”Ÿæ—¥ã¯11æœˆä½•æ—¥ï¼Ÿ", answer: "18", solvedRiddle: false, solvedPhoto: false },
            { id: 3, target: "ãƒ•ã‚¡ãƒŸãƒ", riddle: "ãƒ•ã‚¡ãƒŸãƒã®å…¥åº—éŸ³ã€æœ€å¾Œã¯ã€Œãƒ¬ã€ã®éŸ³ã€‚ã§ã¯æœ€åˆã®éŸ³ã¯ï¼Ÿ", answer: "ãƒ•ã‚¡", solvedRiddle: false, solvedPhoto: false }
        ];

        for(let i=BINGO_DATA.length; i<16; i++) {
            BINGO_DATA.push({ id: i, target: `ã‚¹ãƒãƒƒãƒˆ ${i+1}`, riddle: "ç­”ãˆã¯ã€Œã‚ã€", answer: "ã‚", solvedRiddle: false, solvedPhoto: false });
        }

        let currentId = null;

        function render() {
            const board = document.getElementById("bingo-board");
            board.innerHTML = "";
            BINGO_DATA.forEach(d => {
                const cell = document.createElement("div");
                cell.className = "cell";
                if(d.solvedRiddle) cell.classList.add("solved-riddle");
                if(d.solvedPhoto) cell.classList.add("solved-photo");
                if(d.solvedRiddle && d.solvedPhoto) cell.classList.add("complete");
                cell.innerHTML = `<span>${d.target}</span>`;
                cell.onclick = () => openModal(d.id);
                board.appendChild(cell);
            });
        }

        async function openModal(id) {
            currentId = id;
            const data = BINGO_DATA[id];
            document.getElementById("modal-title").innerText = data.target;
            document.getElementById("riddle-text").innerText = data.riddle;
            document.getElementById("modal").style.display = "block";
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
                document.getElementById("video").srcObject = stream;
            } catch (e) { alert("ã‚«ãƒ¡ãƒ©èµ·å‹•ä¸å¯"); }
        }

        function closeModal() {
            const stream = document.getElementById("video").srcObject;
            if (stream) stream.getTracks().forEach(t => t.stop());
            document.getElementById("modal").style.display = "none";
            render();
        }

        function checkAnswer() {
            if (document.getElementById("answer-input").value.trim() === BINGO_DATA[currentId].answer) {
                alert("æ­£è§£ï¼"); BINGO_DATA[currentId].solvedRiddle = true; render();
            } else { alert("æ®‹å¿µï¼"); }
        }

        // â˜…GitHub Pagesç”¨ã«ç›´æ¥ Gemini API ã‚’å‘¼ã¶ã‚ˆã†ã«å¤‰æ›´
        async function analyze() {
            const video = document.getElementById("video");
            const canvas = document.getElementById("canvas");
            const status = document.getElementById("ai-status");
            const apiKey = document.getElementById("test-api-key").value.trim();

            if(!apiKey) { alert("APIã‚­ãƒ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚"); return; }

            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            canvas.getContext("2d").drawImage(video, 0, 0);
            const imgBase64 = canvas.toDataURL("image/jpeg", 0.7).split(",")[1];

            status.innerText = "AIè§£æä¸­...";
            
            // ç›´æ¥ Google API ã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’å©ã
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{
                            parts: [
                                { text: `ç”»åƒã«ã€Œ${BINGO_DATA[currentId].target}ã€ã«é–¢é€£ã™ã‚‹ã‚‚ã®ãŒå†™ã£ã¦ã„ã‚‹ã‹åˆ¤å®šã—ã¦ãã ã•ã„ã€‚çµæœã¯ã€Œã¯ã„ã€ã¾ãŸã¯ã€Œã„ã„ãˆã€ã®1å˜èªã®ã¿ã§ç­”ãˆã¦ã€‚` },
                                { inline_data: { mime_type: "image/jpeg", data: imgBase64 } }
                            ]
                        }]
                    })
                });
                
                const res = await response.json();
                if(res.error) throw new Error(res.error.message);
                
                const aiAnswer = res.candidates[0].content.parts[0].text.trim();
                if(aiAnswer.includes("ã¯ã„")) {
                    alert("AIãŒç¢ºèªã—ã¾ã—ãŸï¼æˆåŠŸï¼");
                    BINGO_DATA[currentId].solvedPhoto = true; render();
                } else { alert("èªè­˜ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚"); }
            } catch (e) { alert("ã‚¨ãƒ©ãƒ¼: " + e.message); }
            status.innerText = "å¾…æ©Ÿä¸­";
        }

        render();
    </script>
</body>
</html>
