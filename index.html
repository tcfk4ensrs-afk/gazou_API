<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BINGO MYSTERY AI - Final Prototype</title>
    <style>
        :root { --primary: #00f2fe; --accent: #4facfe; --bg: #0f172a; --glass: rgba(255, 255, 255, 0.1); }
        body { font-family: sans-serif; background: var(--bg); color: white; margin: 0; padding: 10px; display: flex; flex-direction: column; align-items: center; }
        
        .setup-section { width: 95%; max-width: 400px; background: var(--glass); padding: 10px; border-radius: 12px; margin-bottom: 15px; border: 1px dashed var(--accent); position: relative; }
        .setup-section input { width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #334155; background: #000; color: #fff; box-sizing: border-box; }
        .reset-btn { position: absolute; right: -60px; top: 10px; font-size: 0.6rem; background: #ef4444; color: white; border: none; padding: 5px; border-radius: 5px; cursor: pointer; }

        .bingo-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; width: 100%; max-width: 400px; margin-bottom: 20px; }
        .cell { 
            aspect-ratio: 1/1; background: var(--glass); border: 1px solid rgba(255,255,255,0.1); border-radius: 10px; 
            display: flex; flex-direction: column; justify-content: center; align-items: center; 
            font-size: 0.6rem; font-weight: bold; text-align: center; cursor: pointer; padding: 5px; box-sizing: border-box; 
        }
        .cell.identified { border: 2px solid #fbbf24; } 
        .cell.complete { background: linear-gradient(135deg, var(--primary), var(--accent)); color: #0f172a; border: none; box-shadow: 0 0 15px var(--primary); }
        .ans-label { font-size: 0.5rem; margin-top: 4px; border-top: 1px solid rgba(0,0,0,0.2); width: 100%; padding-top: 2px; }

        #modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 100; padding: 20px; box-sizing: border-box; overflow-y: auto; }
        .modal-content { max-width: 400px; margin: 0 auto; }
        .input-group { background: rgba(255,255,255,0.05); padding: 15px; border-radius: 15px; margin-bottom: 15px; border: 1px solid rgba(255,255,255,0.1); }
        
        #view-container { width: 100%; aspect-ratio: 1/1; background: #000; border-radius: 12px; overflow: hidden; margin: 10px 0; border: 2px solid #334155; position: relative; }
        video, canvas { width: 100%; height: 100%; object-fit: cover; position: absolute; top: 0; left: 0; }
        
        button { border: none; border-radius: 10px; padding: 14px; font-weight: bold; cursor: pointer; width: 100%; font-size: 1rem; margin-top: 10px; }
        .btn-capture { background: var(--primary); color: #0f172a; }
        .btn-solve { background: #fbbf24; color: #000; }
        .btn-close { background: #334155; color: white; margin-top: 10px; }
        .input-text { width: 100%; padding: 12px; border-radius: 8px; border: 1px solid #475569; background: #1e293b; color: white; box-sizing: border-box; margin-top: 10px; }
    </style>
</head>
<body>

    <h2 style="margin: 10px 0;">BINGO MYSTERY AI</h2>

    <div class="setup-section">
        <input type="password" id="test-api-key" placeholder="Gemini APIã‚­ãƒ¼ã‚’å…¥åŠ›">
        <button class="reset-btn" onclick="resetGame()">ãƒªã‚»ãƒƒãƒˆ</button>
    </div>

    <div class="bingo-grid" id="bingo-board"></div>

    <div id="modal">
        <div class="modal-content">
            <h2 id="modal-title" style="color:var(--primary); margin:0 0 10px 0;">TARGET</h2>
            
            <div id="capture-section">
                <div id="view-container">
                    <video id="video" autoplay playsinline></video>
                    <canvas id="canvas"></canvas>
                </div>
                <button id="capture-btn" class="btn-capture" onclick="analyzeSpot()">ğŸ“¸ æ’®å½±ã—ã¦ã‚¹ãƒãƒƒãƒˆåˆ¤å®š</button>
                <div id="ai-status" style="font-size:0.75rem; text-align:center; margin-top:8px; color:#94a3b8;">å¯¾è±¡ç‰©ã‚’æ’®å½±ã—ã¦ãã ã•ã„</div>
            </div>

            <div id="riddle-section" style="display:none;" class="input-group">
                <div style="color:#fbbf24; font-size:0.8rem; font-weight:bold;">MISSION: è¬ã‚’è§£ã‘</div>
                <p id="riddle-text" style="line-height: 1.6; margin: 10px 0;"></p>
                <input type="text" id="answer-input" class="input-text" placeholder="ç­”ãˆã‚’å…¥åŠ›">
                <button class="btn-solve" onclick="finalCheck()">ç­”ãˆåˆã‚ã›</button>
            </div>

            <button class="btn-close" onclick="closeModal()">æˆ»ã‚‹</button>
        </div>
    </div>

    <script>
        // â˜… 1. ãƒ‡ãƒ¼ã‚¿ã®å®šç¾©ï¼ˆã“ã“ã«16ãƒã‚¹åˆ†ã®å€‹åˆ¥ã®ç­”ãˆã‚’æ›¸ãï¼‰
        const DEFAULT_BINGO_DATA = [
            { id: 0, target: "ã‚»ãƒ–ãƒ³ã‚¤ãƒ¬ãƒ–ãƒ³", riddle: "æœã¯4æœ¬ã€æ˜¼ã¯2æœ¬ã€å¤œã¯3æœ¬ã®ç”Ÿãç‰©ã¯ï¼Ÿ", answer: "äººé–“", identified: false, solved: false },
            { id: 1, target: "ä»»å¤©å ‚", riddle: "ãƒãƒªã‚ªã®å¸½å­ã®ãƒãƒ¼ã‚¯ã¯ï¼Ÿ", answer: "M", identified: false, solved: false },
            { id: 2, target: "ãƒ‡ã‚£ã‚ºãƒ‹ãƒ¼", riddle: "ãƒŸãƒƒã‚­ãƒ¼ã®èª•ç”Ÿæ—¥ã¯11æœˆ18æ—¥ã€‚ã§ã¯ç›¸æ–¹ã®ãƒŸãƒ‹ãƒ¼ã®èª•ç”Ÿæ—¥ã¯ï¼Ÿ", answer: "11æœˆ18æ—¥", identified: false, solved: false },
            { id: 3, target: "ãƒ•ã‚¡ãƒŸãƒ", riddle: "ã€Œã‚ãªãŸã¨ã‚³ãƒ³ãƒ“ã«ã€ã®ç¶šãã¯ï¼Ÿ", answer: "ãƒ•ã‚¡ãƒŸãƒªãƒ¼ãƒãƒ¼ãƒˆ", identified: false, solved: false },
            { id: 4, target: "ãƒ­ãƒ¼ã‚½ãƒ³", riddle: "ãƒ­ã‚´ã«ã‚ã‚‹ãƒŸãƒ«ã‚¯ç¼¶ã®è‰²ã¯ï¼Ÿ", answer: "é’", identified: false, solved: false },
            { id: 5, target: "ãƒã‚¯ãƒ‰ãƒŠãƒ«ãƒ‰", riddle: "ãƒãƒ†ãƒˆã®Mã‚µã‚¤ã‚ºã¯ã€ä½•gä»¥ä¸Šï¼Ÿï¼ˆç›®å®‰ï¼‰", answer: "135", identified: false, solved: false },
            { id: 6, target: "éƒµä¾¿å±€", riddle: "æ—¥æœ¬ã®éƒµä¾¿ãƒãƒ¼ã‚¯ï¼ˆã€’ï¼‰ã®ç”±æ¥ã¨ãªã£ãŸã‚«ã‚¿ã‚«ãƒŠã¯ï¼Ÿ", answer: "ãƒ†", identified: false, solved: false },
            { id: 7, target: "ã‚¹ã‚¿ãƒ¼ãƒãƒƒã‚¯ã‚¹", riddle: "ãƒ­ã‚´ã®äººé­šã®åå‰ã¯ï¼Ÿ", answer: "ã‚µã‚¤ãƒ¬ãƒ³", identified: false, solved: false },
            { id: 8, target: "ãƒ€ã‚¤ã‚½ãƒ¼", riddle: "ç¤¾åã®ç”±æ¥ã¯ã€Œå¤§ããªè”µã€ï¼Ÿãã‚Œã¨ã‚‚ã€Œå¤§ããå‰µã‚‹ã€ï¼Ÿ", answer: "å¤§ããå‰µã‚‹", identified: false, solved: false },
            { id: 9, target: "ãƒ¦ãƒ‹ã‚¯ãƒ­", riddle: "ã€Œãƒ¦ãƒ‹ã‚¯ãƒ­ã€ã®æ­£å¼åç§°ã¯ã€Œãƒ¦ãƒ‹ãƒ¼ã‚¯ãƒ»ã‚¯ãƒ­ãƒ¼ã‚¸ãƒ³ã‚°ãƒ»â—â—â—â—â—ã€", answer: "ã‚¦ã‚§ã‚¢ãƒã‚¦ã‚¹", identified: false, solved: false },
            { id: 10, target: "ãã‚‰å¯¿å¸", riddle: "5çš¿å…¥ã‚Œã‚‹ã¨å›ã‚‹ã‚²ãƒ¼ãƒ ã®åå‰ã¯ï¼Ÿ", answer: "ãƒ“ãƒƒãã‚‰ãƒãƒ³", identified: false, solved: false },
            { id: 11, target: "å‰é‡å®¶", riddle: "ãƒ­ã‚´ã®ç‰›ã®è§’ã®é–“ã«æã‹ã‚Œã¦ã„ã‚‹ã®ã¯ä½•ï¼Ÿ", answer: "ã²ã‚‡ã†ãŸã‚“", identified: false, solved: false },
            { id: 12, target: "ãƒ‹ãƒˆãƒª", riddle: "ã‚­ãƒ£ãƒƒãƒã‚³ãƒ”ãƒ¼ã¯ã€ŒãŠã€ã­ã ã‚“â—â—â—ã€", answer: "ä»¥ä¸Š", identified: false, solved: false },
            { id: 13, target: "ã‚¤ã‚ªãƒ³", riddle: "æ—§ç¤¾åã¯ï¼Ÿ", answer: "ã‚¸ãƒ£ã‚¹ã‚³", identified: false, solved: false },
            { id: 14, target: "ã‚¬ã‚¹ãƒˆ", riddle: "çœ‹æ¿ã«ã‚ã‚‹èµ¤ã„é³¥ã®åå‰ã¯ï¼Ÿ", answer: "ãªã—", identified: false, solved: false }, // å®Ÿã¯åå‰ã¯ãªã„
            { id: 15, target: "ã‚³ã‚«ã‚³ãƒ¼ãƒ©", riddle: "ã‚µãƒ³ã‚¿ã‚¯ãƒ­ãƒ¼ã‚¹ã‚’ä»Šã®ã‚¤ãƒ¡ãƒ¼ã‚¸ï¼ˆèµ¤ï¼‰ã«ã—ãŸã®ã¯ã©ã®ä¼šç¤¾ï¼Ÿ", answer: "ã‚³ã‚«ã‚³ãƒ¼ãƒ©", identified: false, solved: false }
        ];

        let BINGO_MASTER = [];
        let currentIdx = null;

        // â˜… 2. ä¿å­˜ãƒ»èª­ã¿è¾¼ã¿æ©Ÿèƒ½
        function loadGame() {
            const saved = localStorage.getItem('bingo_save_data');
            if (saved) {
                BINGO_MASTER = JSON.parse(saved);
            } else {
                BINGO_MASTER = JSON.parse(JSON.stringify(DEFAULT_BINGO_DATA));
            }
            renderBoard();
        }

        function saveGame() {
            localStorage.setItem('bingo_save_data', JSON.stringify(BINGO_MASTER));
        }

        function resetGame() {
            if(confirm("é€²æ—ã‚’ã™ã¹ã¦ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ")) {
                localStorage.removeItem('bingo_save_data');
                location.reload();
            }
        }

        function renderBoard() {
            const board = document.getElementById("bingo-board");
            board.innerHTML = "";
            BINGO_MASTER.forEach((d, i) => {
                const cell = document.createElement("div");
                cell.className = "cell";
                if(d.identified) cell.classList.add("identified");
                if(d.solved) cell.classList.add("complete");
                
                let content = `<span>${d.target}</span>`;
                if(d.solved) {
                    content += `<div class="ans-label">æ­£è§£: ${d.answer}</div>`;
                }
                cell.innerHTML = content;
                cell.onclick = () => openModal(i);
                board.appendChild(cell);
            });
        }

        async function openModal(i) {
            currentIdx = i;
            const data = BINGO_MASTER[i];
            document.getElementById("modal-title").innerText = data.target;
            document.getElementById("modal").style.display = "block";
            
            const canvas = document.getElementById("canvas");
            const video = document.getElementById("video");
            const riddleSec = document.getElementById("riddle-section");
            const captureBtn = document.getElementById("capture-btn");

            if(data.identified) {
                video.style.display = "none";
                canvas.style.display = "none";
                captureBtn.style.display = "none";
                riddleSec.style.display = "block";
                document.getElementById("riddle-text").innerText = data.riddle;
                document.getElementById("ai-status").innerText = "èªè­˜æ¸ˆã¿ã‚¹ãƒãƒƒãƒˆ";
            } else {
                video.style.display = "block";
                canvas.style.display = "none";
                captureBtn.style.display = "block";
                riddleSec.style.display = "none";
                document.getElementById("ai-status").innerText = "æ’®å½±ã—ã¦ãã ã•ã„";
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
                    video.srcObject = stream;
                } catch (e) { alert("ã‚«ãƒ¡ãƒ©èµ·å‹•å¤±æ•—"); }
            }
        }

        function closeModal() {
            const video = document.getElementById("video");
            if (video.srcObject) {
                video.srcObject.getTracks().forEach(t => t.stop());
                video.srcObject = null;
            }
            document.getElementById("modal").style.display = "none";
            renderBoard();
        }

        async function analyzeSpot() {
            const apiKey = document.getElementById("test-api-key").value.trim();
            if(!apiKey) { alert("APIã‚­ãƒ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"); return; }

            const video = document.getElementById("video");
            const canvas = document.getElementById("canvas");
            const ctx = canvas.getContext("2d");
            const status = document.getElementById("ai-status");
            const data = BINGO_MASTER[currentIdx];

            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            ctx.drawImage(video, 0, 0);
            
            video.style.display = "none";
            canvas.style.display = "block";
            status.innerText = "AIè§£æä¸­...";

            const imgBase64 = canvas.toDataURL("image/jpeg", 0.7).split(",")[1];
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{
                            parts: [
                                { text: `ç”»åƒã«ã€Œ${data.target}ã€ã«é–¢é€£ã™ã‚‹ã‚‚ã®ãŒå†™ã£ã¦ã„ã‚‹ã‹åˆ¤å®šã—ã¦ãã ã•ã„ã€‚ã€Œã¯ã„ã€ã‹ã€Œã„ã„ãˆã€ã§ç­”ãˆã¦ã€‚` },
                                { inline_data: { mime_type: "image/jpeg", data: imgBase64 } }
                            ]
                        }]
                    })
                });
                const res = await response.json();
                const aiAnswer = res.candidates[0].content.parts[0].text.trim();

                if(aiAnswer.includes("ã¯ã„")) {
                    alert("èªè­˜æˆåŠŸï¼è¬ãŒå‡ºç¾ã—ã¾ã—ãŸã€‚");
                    data.identified = true;
                    saveGame(); // é€²æ—ä¿å­˜
                    document.getElementById("capture-btn").style.display = "none";
                    document.getElementById("riddle-section").style.display = "block";
                    document.getElementById("riddle-text").innerText = data.riddle;
                    status.innerText = "èªè­˜æˆåŠŸ";
                } else {
                    alert("èªè­˜ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚");
                    video.style.display = "block";
                    canvas.style.display = "none";
                    status.innerText = "æ’®å½±ã—ã¦ãã ã•ã„";
                }
            } catch (e) { alert("Error: " + e.message); }
        }

        function finalCheck() {
            const val = document.getElementById("answer-input").value.trim();
            const data = BINGO_MASTER[currentIdx];
            if (val === data.answer) {
                alert("æ­£è§£ï¼ãƒ“ãƒ³ã‚´ã‚«ãƒ¼ãƒ‰ãŒæ›´æ–°ã•ã‚Œã¾ã—ãŸã€‚");
                data.solved = true;
                saveGame(); // é€²æ—ä¿å­˜
                closeModal();
            } else { alert("ç­”ãˆãŒé•ã„ã¾ã™ã€‚"); }
        }

        // èµ·å‹•æ™‚ã«ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚€
        loadGame();
    </script>
</body>
</html>
