<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BINGO MYSTERY AI - Special Edition</title>
    <style>
        :root { --bg: #0f172a; --glass: rgba(255, 255, 255, 0.1); }
        /* Âàó„Åî„Å®„ÅÆËâ≤ÂÆöÁæ© */
        .col-red { --theme: #ff4d4d; }
        .col-blue { --theme: #4d94ff; }
        .col-green { --theme: #2ecc71; }
        .col-yellow { --theme: #f1c40f; }

        body { font-family: sans-serif; background: var(--bg); color: white; margin: 0; padding: 10px; display: flex; flex-direction: column; align-items: center; min-height: 100vh; overflow-x: hidden; }
        
        /* Ë®≠ÂÆö„Ç®„É™„Ç¢ */
        .setup-section { width: 95%; max-width: 400px; background: var(--glass); padding: 10px; border-radius: 12px; margin-bottom: 10px; border: 1px dashed #4facfe; box-sizing: border-box; }
        .setup-section input { width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #334155; background: #000; color: #fff; box-sizing: border-box; }

        /* „Ç¢„Ç§„ÉÜ„É†Ë°®Á§∫„Ç®„É™„Ç¢ */
        .item-inventory { width: 95%; max-width: 400px; display: flex; justify-content: space-between; align-items: center; background: rgba(255,255,255,0.05); padding: 10px 15px; border-radius: 15px; margin-bottom: 15px; border: 1px solid gold; box-sizing: border-box; }
        .item-btn { background: linear-gradient(135deg, gold, #f39c12); color: black; border: none; padding: 8px 15px; border-radius: 20px; font-weight: bold; cursor: pointer; font-size: 0.8rem; }
        .item-btn:disabled { background: #444; color: #888; cursor: not-allowed; }

        /* „Éì„É≥„Ç¥„Ç∞„É™„ÉÉ„Éâ */
        .bingo-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; width: 100%; max-width: 400px; margin-bottom: 20px; }
        .cell { 
            aspect-ratio: 1/1; background: var(--glass); border: 2px solid var(--theme); border-radius: 10px; 
            display: flex; flex-direction: column; justify-content: center; align-items: center; 
            font-size: 0.6rem; font-weight: bold; text-align: center; cursor: pointer; padding: 5px; box-sizing: border-box; color: var(--theme);
        }
        .cell.identified { background: rgba(255, 255, 255, 0.05); box-shadow: inset 0 0 10px var(--theme); } 
        .cell.complete { background: var(--theme); color: #000; border: none; box-shadow: 0 0 15px var(--theme); }
        .ans-label { font-size: 0.5rem; margin-top: 4px; border-top: 1px solid rgba(0,0,0,0.2); width: 100%; padding-top: 2px; }

        /* „Éì„É≥„Ç¥ÊºîÂá∫Áî®„Ç™„Éº„Éê„Éº„É¨„Ç§ */
        #bingo-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000; flex-direction: column; justify-content: center; align-items: center; pointer-events: none; }
        .bingo-text { font-size: 5rem; font-weight: bold; color: gold; text-shadow: 0 0 20px orange; animation: bounce 1s infinite; }
        @keyframes bounce { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.2); } }

        /* „É¢„Éº„ÉÄ„É´ */
        #modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 100; padding: 20px; box-sizing: border-box; overflow-y: auto; }
        .modal-content { max-width: 400px; margin: 0 auto; }
        .input-group { background: rgba(255,255,255,0.05); padding: 15px; border-radius: 15px; margin-bottom: 15px; border: 1px solid rgba(255,255,255,0.1); }
        #view-container { width: 100%; aspect-ratio: 1/1; background: #000; border-radius: 12px; overflow: hidden; margin: 10px 0; border: 2px solid #334155; position: relative; }
        video, canvas { width: 100%; height: 100%; object-fit: cover; position: absolute; top: 0; left: 0; }
        
        button { border: none; border-radius: 10px; padding: 14px; font-weight: bold; cursor: pointer; width: 100%; font-size: 1rem; margin-top: 10px; }
        .btn-capture { background: #4facfe; color: white; }
        .btn-solve { background: #fbbf24; color: #000; }
        .btn-close { background: #334155; color: white; }
        .input-text { width: 100%; padding: 12px; border-radius: 8px; border: 1px solid #475569; background: #1e293b; color: white; box-sizing: border-box; margin-top: 10px; }
        
        .footer-area { width: 100%; max-width: 400px; display: flex; justify-content: center; padding: 20px 0; }
        .reset-btn { background: #444; color: #888; border: none; padding: 8px; border-radius: 5px; cursor: pointer; font-size: 0.6rem; }
    </style>
</head>
<body>

    <h2 style="margin: 10px 0;">BINGO MYSTERY AI</h2>

    <div class="setup-section">
        <input type="password" id="test-api-key" placeholder="Gemini API„Ç≠„Éº„ÇíÂÖ•Âäõ">
    </div>

    <div class="item-inventory">
        <div>
            <span style="font-size: 0.7rem; color: gold; display: block;">ITEM: „Éû„Çπ„Çø„Éº„Ç≠„Éº</span>
            <span id="item-count" style="font-size: 1.2rem; font-weight: bold;">0</span>
        </div>
        <button id="use-item-btn" class="item-btn" onclick="toggleItemMode()">„Ç¢„Ç§„ÉÜ„É†„Çí‰Ωø„ÅÜ</button>
    </div>

    <div class="bingo-grid" id="bingo-board"></div>

    <div class="footer-area">
        <button class="reset-btn" onclick="resetGame()">ÈÄ≤Êçó„ÇíÂÆåÂÖ®„Å´„É™„Çª„ÉÉ„Éà</button>
    </div>

    <div id="bingo-overlay">
        <div class="bingo-text">BINGO!</div>
        <p style="color: gold;">„Ç¢„Ç§„ÉÜ„É†„ÇíGET„Åó„Åæ„Åó„ÅüÔºÅ</p>
    </div>

    <div id="modal">
        <div class="modal-content">
            <h2 id="modal-title" style="color:#4facfe; margin:0 0 10px 0;">TARGET</h2>
            <div id="capture-section">
                <div id="view-container">
                    <video id="video" autoplay playsinline></video>
                    <canvas id="canvas"></canvas>
                </div>
                <button id="capture-btn" class="btn-capture" onclick="analyzeSpot()">üì∏ ÊíÆÂΩ±„Åó„Å¶„Çπ„Éù„ÉÉ„ÉàÂà§ÂÆö</button>
                <div id="ai-status" style="font-size:0.75rem; text-align:center; margin-top:8px; color:#94a3b8;">ÂØæË±°Áâ©„ÇíÊíÆÂΩ±„Åó„Å¶„Åè„Å†„Åï„ÅÑ</div>
            </div>
            <div id="riddle-section" style="display:none;" class="input-group">
                <div style="color:#fbbf24; font-size:0.8rem; font-weight:bold;">MISSION: Ë¨é„ÇíËß£„Åë</div>
                <p id="riddle-text" style="line-height: 1.6; margin: 10px 0;"></p>
                <input type="text" id="answer-input" class="input-text" placeholder="Á≠î„Åà„ÇíÂÖ•Âäõ">
                <button class="btn-solve" onclick="finalCheck()">Á≠î„ÅàÂêà„Çè„Åõ</button>
            </div>
            <button class="btn-close" onclick="closeModal()">Êàª„Çã</button>
        </div>
    </div>

    <script>
        const DEFAULT_BINGO_DATA = [
            { id: 0, target: "„Çª„Éñ„É≥„Ç§„É¨„Éñ„É≥", riddle: "Êúù„ÅØ4Êú¨„ÄÅÊòº„ÅØ2Êú¨„ÄÅÂ§ú„ÅØ3Êú¨„ÅÆÁîü„ÅçÁâ©„ÅØÔºü", answer: "‰∫∫Èñì", identified: false, solved: false },
            { id: 1, target: "‰ªªÂ§©Â†Ç", riddle: "„Éû„É™„Ç™„ÅÆÂ∏ΩÂ≠ê„ÅÆ„Éû„Éº„ÇØ„ÅØÔºü", answer: "M", identified: false, solved: false },
            { id: 2, target: "„Éá„Ç£„Ç∫„Éã„Éº", riddle: "„Éü„ÉÉ„Ç≠„Éº„ÅÆË™ïÁîüÊó•„ÅØ11Êúà18Êó•„ÄÇ„Åß„ÅØ„Éü„Éã„Éº„ÅØÔºü", answer: "11Êúà18Êó•", identified: false, solved: false },
            { id: 3, target: "„Éï„Ç°„Éü„Éû", riddle: "„Äå„ÅÇ„Å™„Åü„Å®„Ç≥„É≥„Éì„Å´„Äç„ÅÆÁ∂ö„Åç„ÅØÔºü", answer: "„Éï„Ç°„Éü„É™„Éº„Éû„Éº„Éà", identified: false, solved: false },
            { id: 4, target: "„É≠„Éº„ÇΩ„É≥", riddle: "„É≠„Ç¥„Å´„ÅÇ„Çã„Éü„É´„ÇØÁº∂„ÅÆËâ≤„ÅØÔºü", answer: "ÁôΩ", identified: false, solved: false },
            { id: 5, target: "„Éû„ÇØ„Éâ„Éä„É´„Éâ", riddle: "„Éù„ÉÜ„Éà„ÅÆM„Çµ„Ç§„Ç∫„ÄÅÁõÆÂÆâ„ÅØ‰ΩïgÔºü", answer: "135", identified: false, solved: false },
            { id: 6, target: "ÈÉµ‰æøÂ±Ä", riddle: "Êó•Êú¨„ÅÆÈÉµ‰æø„Éû„Éº„ÇØÔºà„ÄíÔºâ„ÅÆÁî±Êù•„Å®„Å™„Å£„Åü„Ç´„Çø„Ç´„Éä„ÅØÔºü", answer: "„ÉÜ", identified: false, solved: false },
            { id: 7, target: "„Çπ„Çø„Éº„Éê„ÉÉ„ÇØ„Çπ", riddle: "„É≠„Ç¥„ÅÆ‰∫∫È≠ö„ÅÆÂêçÂâç„ÅØÔºü", answer: "„Çµ„Ç§„É¨„É≥", identified: false, solved: false },
            { id: 8, target: "„ÉÄ„Ç§„ÇΩ„Éº", riddle: "Á§æÂêç„ÅÆÁî±Êù•„ÅØ„ÄåÂ§ß„Åç„Åè‚óè‚óè„Çã„Äç", answer: "Ââµ„Çã", identified: false, solved: false },
            { id: 9, target: "„É¶„Éã„ÇØ„É≠", riddle: "Ê≠£ÂºèÂêçÁß∞„ÅÆÊúÄÂæå„ÅØ„Äå‚óè‚óè‚óè„Éè„Ç¶„Çπ„Äç", answer: "„Ç¶„Çß„Ç¢", identified: false, solved: false },
            { id: 10, target: "„Åè„ÇâÂØøÂè∏", riddle: "5Áöø„Åß1Âõû„Åß„Åç„Çã„Ç≤„Éº„É†„ÅØÔºü", answer: "„Éì„ÉÉ„Åè„Çâ„Éù„É≥", identified: false, solved: false },
            { id: 11, target: "ÂêâÈáéÂÆ∂", riddle: "„É≠„Ç¥„ÅÆÁâõ„ÅÆËßí„ÅÆÈñì„Å´„ÅÇ„Çã„ÇÇ„ÅÆ„ÅØÔºü", answer: "„Å≤„Çá„ÅÜ„Åü„Çì", identified: false, solved: false },
            { id: 12, target: "„Éã„Éà„É™", riddle: "„Ç≠„É£„ÉÉ„ÉÅ„Ç≥„Éî„Éº„ÅØ„Äå„Åä„ÄÅ„Å≠„Å†„Çì‚óè‚óè‚óè„Äç", answer: "‰ª•‰∏ä", identified: false, solved: false },
            { id: 13, target: "„Ç§„Ç™„É≥", riddle: "ÊóßÁ§æÂêç„ÅØÔºü", answer: "„Ç∏„É£„Çπ„Ç≥", identified: false, solved: false },
            { id: 14, target: "„Ç¨„Çπ„Éà", riddle: "ÁúãÊùø„ÅÆËµ§„ÅÑÈ≥•„ÄÇÂêçÂâç„ÅØ„ÅÇ„ÇãÔºü„Å™„ÅÑÔºü", answer: "„Å™„ÅÑ", identified: false, solved: false },
            { id: 15, target: "„Ç≥„Ç´„Ç≥„Éº„É©", riddle: "„Çµ„É≥„Çø„ÇíËµ§Ëâ≤„ÅÆ„Ç§„É°„Éº„Ç∏„Å´„Åó„Åü‰ºöÁ§æ„ÅØÔºü", answer: "„Ç≥„Ç´„Ç≥„Éº„É©", identified: false, solved: false }
        ];

        let BINGO_MASTER = [];
        let itemsCount = 0;
        let completedLines = []; // ÈÅîÊàêÊ∏à„Åø„ÅÆ„Éì„É≥„Ç¥„É©„Ç§„É≥ÔºàID‰øùÊåÅÔºâ
        let itemMode = false; // „Ç¢„Ç§„ÉÜ„É†‰ΩøÁî®„É¢„Éº„Éâ

        function loadGame() {
            const saved = localStorage.getItem('bingo_v2_save');
            if(saved) {
                const data = JSON.parse(saved);
                BINGO_MASTER = data.master;
                itemsCount = data.items || 0;
                completedLines = data.lines || [];
            } else {
                BINGO_MASTER = JSON.parse(JSON.stringify(DEFAULT_BINGO_DATA));
            }
            renderBoard();
            updateItemUI();
        }

        function saveGame() {
            localStorage.setItem('bingo_v2_save', JSON.stringify({
                master: BINGO_MASTER,
                items: itemsCount,
                lines: completedLines
            }));
        }

        function renderBoard() {
            const board = document.getElementById("bingo-board");
            board.innerHTML = "";
            const colors = ['col-red', 'col-blue', 'col-green', 'col-yellow'];

            BINGO_MASTER.forEach((d, i) => {
                const cell = document.createElement("div");
                const colIdx = i % 4;
                cell.className = `cell ${colors[colIdx]}`;
                if(d.identified) cell.classList.add("identified");
                if(d.solved) cell.classList.add("complete");
                
                let content = `<span>${d.target}</span>`;
                if(d.solved) content += `<div class="ans-label">Ê≠£Ëß£: ${d.answer}</div>`;
                cell.innerHTML = content;
                
                cell.onclick = () => handleCellClick(i);
                board.appendChild(cell);
            });
        }

        function handleCellClick(i) {
            if (itemMode) {
                useItemOnCell(i);
            } else {
                openModal(i);
            }
        }

        function updateItemUI() {
            document.getElementById("item-count").innerText = itemsCount;
            const btn = document.getElementById("use-item-btn");
            btn.disabled = itemsCount <= 0;
            btn.innerText = itemMode ? "„Ç≠„É£„É≥„Çª„É´" : "„Ç¢„Ç§„ÉÜ„É†„Çí‰Ωø„ÅÜ";
            btn.style.background = itemMode ? "#ff4d4d" : "";
        }

        function toggleItemMode() {
            if (itemsCount <= 0) return;
            itemMode = !itemMode;
            updateItemUI();
            if (itemMode) alert("„Çπ„Ç≠„É£„É≥„Çí„Çπ„Ç≠„ÉÉ„Éó„Åô„Çã„Éû„Çπ„ÇíÈÅ∏„Çì„Åß„Åè„Å†„Åï„ÅÑ„ÄÇ");
        }

        function useItemOnCell(i) {
            const data = BINGO_MASTER[i];
            if (data.identified || data.solved) {
                alert("„Åô„Åß„Å´„Çπ„Ç≠„É£„É≥Ê∏à„Åø„ÅÆ„Éû„Çπ„Åß„Åô„ÄÇ");
                return;
            }
            if (confirm(`${data.target} „ÅÆ„Çπ„Ç≠„É£„É≥„Çí„Çπ„Ç≠„ÉÉ„Éó„Åó„Å¶Ë¨éËß£„Åç„ÇíË°®Á§∫„Åó„Åæ„Åô„ÅãÔºü`)) {
                itemsCount--;
                data.identified = true;
                itemMode = false;
                saveGame();
                updateItemUI();
                renderBoard();
                openModal(i); // Áõ¥Êé•Ë¨éËß£„ÅçÁîªÈù¢„ÇíÈñã„Åè
            }
        }

        async function openModal(i) {
            currentIdx = i;
            const data = BINGO_MASTER[i];
            document.getElementById("modal-title").innerText = data.target;
            document.getElementById("modal").style.display = "block";
            
            const captureSec = document.getElementById("capture-section");
            const riddleSec = document.getElementById("riddle-section");

            if(data.identified) {
                captureSec.style.display = "none";
                riddleSec.style.display = "block";
                document.getElementById("riddle-text").innerText = data.riddle;
            } else {
                captureSec.style.display = "block";
                riddleSec.style.display = "none";
                document.getElementById("video").style.display = "block";
                document.getElementById("canvas").style.display = "none";
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
                    document.getElementById("video").srcObject = stream;
                } catch (e) { alert("„Ç´„É°„É©„ÅåËµ∑Âãï„Åß„Åç„Åæ„Åõ„Çì"); }
            }
        }

        async function analyzeSpot() {
            const apiKey = document.getElementById("test-api-key").value.trim();
            if(!apiKey) { alert("API„Ç≠„Éº„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ"); return; }

            const video = document.getElementById("video");
            const canvas = document.getElementById("canvas");
            const data = BINGO_MASTER[currentIdx];

            canvas.width = video.videoWidth; canvas.height = video.videoHeight;
            canvas.getContext("2d").drawImage(video, 0, 0);
            video.style.display = "none"; canvas.style.display = "block";
            document.getElementById("ai-status").innerText = "Ëß£Êûê‰∏≠...";

            const imgBase64 = canvas.toDataURL("image/jpeg", 0.7).split(",")[1];
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [
                        { text: `ÁîªÂÉè„Å´„Äå${data.target}„Äç„Å´Èñ¢ÈÄ£„Åô„Çã„ÇÇ„ÅÆ„ÅåÂÜô„Å£„Å¶„ÅÑ„Çã„Åã„Äå„ÅØ„ÅÑ„Äç„Åã„Äå„ÅÑ„ÅÑ„Åà„Äç„ÅßÁ≠î„Åà„Å¶„ÄÇ` },
                        { inline_data: { mime_type: "image/jpeg", data: imgBase64 } }
                    ] }] })
                });
                const res = await response.json();
                if(res.candidates[0].content.parts[0].text.trim().includes("„ÅØ„ÅÑ")) {
                    data.identified = true;
                    saveGame();
                    document.getElementById("capture-section").style.display = "none";
                    document.getElementById("riddle-section").style.display = "block";
                    document.getElementById("riddle-text").innerText = data.riddle;
                } else { alert("Âà§ÂÆöÂ§±Êïó"); video.style.display = "block"; canvas.style.display = "none"; }
            } catch (e) { alert("Error: " + e.message); }
        }

        function finalCheck() {
            const val = document.getElementById("answer-input").value.trim();
            const data = BINGO_MASTER[currentIdx];
            if (val === data.answer) {
                data.solved = true;
                saveGame();
                checkBingo();
                closeModal();
            } else { alert("Á≠î„Åà„ÅåÈÅï„ÅÑ„Åæ„Åô"); }
        }

        function checkBingo() {
            const winPatterns = [
                [0,1,2,3],[4,5,6,7],[8,9,10,11],[12,13,14,15], // Ê®™
                [0,4,8,12],[1,5,9,13],[2,6,10,14],[3,7,11,15], // Á∏¶
                [0,5,10,15],[3,6,9,12] // Êñú„ÇÅ
            ];

            let newBingo = false;
            winPatterns.forEach((pattern, index) => {
                const isWin = pattern.every(idx => BINGO_MASTER[idx].solved);
                if (isWin && !completedLines.includes(index)) {
                    completedLines.push(index);
                    itemsCount++;
                    newBingo = true;
                }
            });

            if (newBingo) {
                showBingoEffect();
                saveGame();
                updateItemUI();
            }
        }

        function showBingoEffect() {
            const overlay = document.getElementById("bingo-overlay");
            overlay.style.display = "flex";
            setTimeout(() => { overlay.style.display = "none"; }, 3000);
        }

        function closeModal() {
            const video = document.getElementById("video");
            if (video.srcObject) video.srcObject.getTracks().forEach(t => t.stop());
            document.getElementById("modal").style.display = "none";
            renderBoard();
        }

        function resetGame() {
            if(confirm("ÈÄ≤Êçó„Çí„É™„Çª„ÉÉ„Éà„Åó„Åæ„Åô„ÅãÔºü")) { localStorage.removeItem('bingo_v2_save'); location.reload(); }
        }

        loadGame();
    </script>
</body>
</html>
