<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Spot Explorer (Gemini)</title>
    <style>
        :root { --primary: #00f2fe; --accent: #4facfe; --bg: #0f172a; --glass: rgba(255, 255, 255, 0.1); }
        body { font-family: sans-serif; background: var(--bg); color: white; display: flex; flex-direction: column; align-items: center; margin: 0; padding: 20px; }
        #webcam-outer { position: relative; margin: 20px auto; width: 320px; height: 320px; border-radius: 30px; padding: 8px; background: linear-gradient(135deg, var(--primary), var(--accent)); }
        #webcam-container { width: 100%; height: 100%; border-radius: 22px; overflow: hidden; background: #000; position: relative; }
        video { width: 100%; height: 100%; object-fit: cover; }
        canvas { display: none; }
        .controls { margin: 20px 0; width: 100%; display: flex; flex-direction: column; align-items: center; gap: 15px; }
        button { border: none; border-radius: 50px; padding: 16px 40px; font-size: 1rem; font-weight: bold; color: white; cursor: pointer; width: 80%; max-width: 300px; }
        .btn-capture { background: linear-gradient(to right, #ff416c, #ff4b2b); }
        .info-card { display: none; width: 85%; max-width: 400px; padding: 25px; background: var(--glass); backdrop-filter: blur(15px); border-radius: 25px; border: 1px solid rgba(255, 255, 255, 0.1); margin-bottom: 40px; }
    </style>
</head>
<body>

    <h1>Spot Explorer Gemini</h1>
    <div id="status">„Ç∑„Çπ„ÉÜ„É†„ÇíËµ∑Âãï„Åó„Å¶„Åè„Å†„Åï„ÅÑ</div>
    
    <div id="webcam-outer">
        <div id="webcam-container">
            <video id="video" autoplay playsinline></video>
            <canvas id="canvas"></canvas>
        </div>
    </div>

    <div id="info-area" class="info-card">
        <div id="result-label" style="font-size: 1.4rem; font-weight: bold; color: var(--primary);"></div>
        <p id="result-desc" style="line-height: 1.6; color: #cbd5e1;"></p>
        <div id="distance-tag" style="color: #00ff88; font-weight: bold;"></div>
    </div>

    <div class="controls">
        <button id="start-btn" style="background: #007bff;" onclick="initSystem()">START</button>
        <button id="capture-btn" class="btn-capture" style="display: none;" onclick="analyze()">üì∏ ANALYSIS</button>
        <button id="reset-btn" style="display: none; background: #444;" onclick="location.reload()">RETRY</button>
    </div>

    <script>
        const TARGETS = {
            "Nintendo": { lat: 35.6586, lon: 139.7454, title: "‰ªªÂ§©Â†Ç„Çπ„Éù„ÉÉ„Éà", desc: "AI„Åå‰ªªÂ§©Â†Ç„ÇíË™çË≠ò„Åó„Åæ„Åó„ÅüÔºÅ" },
            "„Çª„Éñ„É≥„Ç§„É¨„Éñ„É≥": { lat: 35.6812, lon: 139.7671, title: "„Çª„Éñ„É≥„Ç§„É¨„Éñ„É≥", desc: "AI„Åå„Çª„Éñ„É≥„Ç§„É¨„Éñ„É≥„ÇíË™çË≠ò„Åó„Åæ„Åó„ÅüÔºÅ" }
        };

        let userLat, userLon;

        async function initSystem() {
            navigator.geolocation.getCurrentPosition(async (pos) => {
                userLat = pos.coords.latitude;
                userLon = pos.coords.longitude;
                const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
                document.getElementById("video").srcObject = stream;
                document.getElementById("start-btn").style.display = "none";
                document.getElementById("capture-btn").style.display = "block";
                document.getElementById("status").innerText = "Âà§ÂÆöÂØæË±°„ÇíÊò†„Åó„Å¶„Åè„Å†„Åï„ÅÑ";
            });
        }

        async function analyze() {
            const video = document.getElementById("video");
            const status = document.getElementById("status");
            video.pause();
            status.innerText = "AIËß£Êûê‰∏≠...";
            
            const canvas = document.getElementById("canvas");
            const scale = Math.min(1, 800 / video.videoWidth);
            canvas.width = video.videoWidth * scale;
            canvas.height = video.videoHeight * scale;
            canvas.getContext("2d").drawImage(video, 0, 0, canvas.width, canvas.height);
            const base64Image = canvas.toDataURL("image/jpeg", 0.7).split(",")[1];

            try {
                const response = await fetch('/.netlify/functions/analyze', {
                    method: 'POST',
                    body: JSON.stringify({
                        image: base64Image,
                        prompt: "ÁîªÂÉè„Å´Nintendo„Åã„Çª„Éñ„É≥„Ç§„É¨„Éñ„É≥„ÅÆÁúãÊùø„Åå„ÅÇ„Çå„Å∞„Åù„ÅÆÂêçÂâç„ÅÆ„Åø„ÄÅ„Å™„Åë„Çå„Å∞None„Å®Á≠î„Åà„Å¶„ÄÇ"
                    })
                });

                const data = await response.json();
                if (!response.ok) throw new Error(data.error || "Server Error");

                const resultText = data.candidates[0].content.parts[0].text.trim();
                if (resultText !== "None" && TARGETS[resultText]) {
                    const target = TARGETS[resultText];
                    const dist = calculateDistance(userLat, userLon, target.lat, target.lon);
                    if (dist <= 50) {
                        showResult(target, dist);
                        status.innerText = "ÊàêÂäüÔºÅ";
                    } else {
                        status.innerText = "Â†¥ÊâÄ„ÅåÈÅ†„Åô„Åé„Åæ„Åô„ÄÇ";
                    }
                } else {
                    status.innerText = "Ë¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„Åß„Åó„Åü„ÄÇ";
                }
            } catch (e) {
                status.innerText = "„Ç®„É©„Éº: " + e.message;
            }
            document.getElementById("capture-btn").style.display = "none";
            document.getElementById("reset-btn").style.display = "block";
        }

        function showResult(target, dist) {
            document.getElementById("info-area").style.display = "block";
            document.getElementById("result-label").innerText = target.title;
            document.getElementById("result-desc").innerText = target.desc;
            document.getElementById("distance-tag").innerText = `üìç Ë∑ùÈõ¢: ${Math.round(dist)}m`;
        }

        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371000;
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat / 2)**2 + Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.sin(dLon / 2)**2;
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
        }
    </script>
</body>
</html>
