<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Spot Explorer (Gemini)</title>
    <style>
        :root { --primary: #00f2fe; --accent: #4facfe; --bg: #0f172a; --glass: rgba(255, 255, 255, 0.1); }
        body { font-family: sans-serif; background: var(--bg); color: white; display: flex; flex-direction: column; align-items: center; margin: 0; padding: 20px; }
        #webcam-outer { position: relative; margin: 20px auto; width: 320px; height: 320px; border-radius: 30px; padding: 8px; background: linear-gradient(135deg, var(--primary), var(--accent)); }
        #webcam-container { width: 100%; height: 100%; border-radius: 22px; overflow: hidden; background: #000; position: relative; }
        video { width: 100%; height: 100%; object-fit: cover; }
        canvas { display: none; }
        
        /* å¾…æ©Ÿä¸­ã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ç”¨ */
        .loading-dots:after { content: ' .'; animation: dots 1.5s steps(5, end) infinite; }
        @keyframes dots { 0%, 20% { content: ' .'; } 40% { content: ' ..'; } 60% { content: ' ...'; } 80%, 100% { content: ''; } }

        .controls { margin: 20px 0; width: 100%; display: flex; flex-direction: column; align-items: center; gap: 15px; }
        button { border: none; border-radius: 50px; padding: 16px 40px; font-size: 1rem; font-weight: bold; color: white; cursor: pointer; width: 80%; max-width: 300px; transition: 0.3s; }
        .btn-capture { background: linear-gradient(to right, #ff416c, #ff4b2b); }
        .info-card { display: none; width: 85%; max-width: 400px; padding: 25px; background: var(--glass); backdrop-filter: blur(15px); border-radius: 25px; border: 1px solid rgba(255, 255, 255, 0.2); margin-bottom: 40px; }
        
        /* è§£æçµæœã®å¼·èª¿ */
        .ai-label { font-size: 0.8rem; color: #94a3b8; text-transform: uppercase; margin-bottom: 5px; }
        .result-title { font-size: 1.5rem; font-weight: bold; color: var(--primary); }
    </style>
</head>
<body>

    <h1>Spot Explorer Gemini</h1>
    <div id="status">ã‚·ã‚¹ãƒ†ãƒ ã‚’å¾…æ©Ÿä¸­</div>
    
    <div id="webcam-outer">
        <div id="webcam-container">
            <video id="video" autoplay playsinline></video>
            <canvas id="canvas"></canvas>
        </div>
    </div>

    <div id="info-area" class="info-card">
        <div class="ai-label">AI Analysis Result</div>
        <div id="result-label" class="result-title"></div>
        <hr style="border: 0; border-top: 1px solid rgba(255,255,255,0.1); margin: 15px 0;">
        <p id="result-desc" style="line-height: 1.6; color: #cbd5e1;"></p>
        <div id="distance-tag" style="color: #00ff88; font-weight: bold; margin-top: 10px;"></div>
    </div>

    <div class="controls">
        <button id="start-btn" style="background: #007bff;" onclick="initSystem()">START SYSTEM</button>
        <button id="capture-btn" class="btn-capture" style="display: none;" onclick="analyze()">ğŸ“¸ ANALYSIS</button>
        <button id="reset-btn" style="display: none; background: #444;" onclick="location.reload()">RETRY (å†é–‹)</button>
    </div>

    <script>
        const TARGETS = {
            "Nintendo": { lat: 35.6586, lon: 139.7454, info: "ä»»å¤©å ‚ã‚¹ãƒãƒƒãƒˆå‘¨è¾ºã§ã™ã€‚ç‰¹åˆ¥ãªä½“é¨“ãŒå¯èƒ½ã§ã™ã€‚" },
            "ã‚»ãƒ–ãƒ³ã‚¤ãƒ¬ãƒ–ãƒ³": { lat: 35.6812, lon: 139.7671, info: "ã‚»ãƒ–ãƒ³ã‚¤ãƒ¬ãƒ–ãƒ³ã‚’èªè­˜ã€‚é™å®šã‚¯ãƒ¼ãƒãƒ³ãŒä½¿ãˆã¾ã™ã€‚" }
        };

        let userLat, userLon;

        // 1. ã‚·ã‚¹ãƒ†ãƒ èµ·å‹•ï¼ˆå¾…ã¡æ™‚é–“ã®è¡¨ç¤ºã‚’å¼·åŒ–ï¼‰
        async function initSystem() {
            const btn = document.getElementById("start-btn");
            const status = document.getElementById("status");
            
            btn.disabled = true;
            btn.innerText = "Initializing...";
            status.innerHTML = '<span class="loading-dots">GPSã¨ã‚«ãƒ¡ãƒ©ã‚’èµ·å‹•ä¸­</span>';

            navigator.geolocation.getCurrentPosition(async (pos) => {
                userLat = pos.coords.latitude;
                userLon = pos.coords.longitude;
                
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
                    document.getElementById("video").srcObject = stream;
                    
                    btn.style.display = "none";
                    document.getElementById("capture-btn").style.display = "block";
                    status.innerText = "æº–å‚™å®Œäº†ã€‚åˆ¤å®šã—ãŸã„ã‚‚ã®ã‚’æ˜ ã—ã¦ãã ã•ã„ã€‚";
                } catch (e) {
                    status.innerText = "ã‚«ãƒ¡ãƒ©ã®èµ·å‹•ã«å¤±æ•—ã—ã¾ã—ãŸã€‚";
                }
            }, (err) => {
                status.innerText = "ä½ç½®æƒ…å ±ã‚’è¨±å¯ã—ã¦å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚";
            });
        }

        // 2. åˆ¤å®šå‡¦ç†ï¼ˆä½•ãŒå†™ã£ã¦ã„ã‚‹ã‹ã‚’å‡ºåŠ›ï¼‰
        async function analyze() {
            const video = document.getElementById("video");
            const status = document.getElementById("status");
            video.pause();
            
            status.innerHTML = '<span class="loading-dots">AIé€šä¿¡ä¸­</span>';
            document.getElementById("capture-btn").style.display = "none";

            const canvas = document.getElementById("canvas");
            const scale = Math.min(1, 800 / video.videoWidth);
            canvas.width = video.videoWidth * scale;
            canvas.height = video.videoHeight * scale;
            canvas.getContext("2d").drawImage(video, 0, 0, canvas.width, canvas.height);
            const base64Image = canvas.toDataURL("image/jpeg", 0.7).split(",")[1];

            try {
                const response = await fetch('/.netlify/functions/analyze', {
                    method: 'POST',
                    body: JSON.stringify({
                        image: base64Image,
                        // ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’èª¿æ•´ï¼šä½•ãŒå†™ã£ã¦ã„ã‚‹ã‹ç­”ãˆã•ã›ã‚‹
                        prompt: "ç”»åƒã«ä½•ãŒå†™ã£ã¦ã„ã‚‹ã‹æ—¥æœ¬èª10æ–‡å­—ç¨‹åº¦ã§ç°¡æ½”ã«ç­”ãˆã¦ã€‚ã‚‚ã—Nintendoã®ãƒ­ã‚´ã‹ã‚»ãƒ–ãƒ³ã‚¤ãƒ¬ãƒ–ãƒ³ã®çœ‹æ¿ãŒã‚ã‚Œã°ã€å¿…ãšã€Nintendoã€ã¾ãŸã¯ã€ã‚»ãƒ–ãƒ³ã‚¤ãƒ¬ãƒ–ãƒ³ã€ã¨ã„ã†å˜èªã‚’å«ã‚ã¦ãã ã•ã„ã€‚"
                    })
                });

                const data = await response.json();
                if (!response.ok) throw new Error(data.error || "Server Error");

                const aiResponse = data.candidates[0].content.parts[0].text.trim();
                showResult(aiResponse);
                status.innerText = "è§£æå®Œäº†";

            } catch (e) {
                status.innerText = "ã‚¨ãƒ©ãƒ¼: " + e.message;
            }
            document.getElementById("reset-btn").style.display = "block";
        }

        // 3. çµæœè¡¨ç¤ºã®ãƒ­ã‚¸ãƒƒã‚¯
        function showResult(aiText) {
            const area = document.getElementById("info-area");
            const label = document.getElementById("result-label");
            const desc = document.getElementById("result-desc");
            const distTag = document.getElementById("distance-tag");

            area.style.display = "block";
            label.innerText = aiText; // AIãŒç­”ãˆãŸå†…å®¹ã‚’ãã®ã¾ã¾ã‚¿ã‚¤ãƒˆãƒ«ã«

            // ç‰¹å®šã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãŒå«ã¾ã‚Œã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
            let foundKey = Object.keys(TARGETS).find(key => aiText.includes(key));

            if (foundKey) {
                const target = TARGETS[foundKey];
                const dist = calculateDistance(userLat, userLon, target.lat, target.lon);
                
                desc.innerText = target.info;
                distTag.innerText = `ğŸ“ ç¾åœ¨åœ°ã‹ã‚‰ã®è·é›¢: ${Math.round(dist)}m`;
                
                if (dist > 50) {
                    distTag.style.color = "#ff4b2b";
                    distTag.innerText += " (ç¯„å›²å¤–ã§ã™)";
                } else {
                    distTag.style.color = "#00ff88";
                    distTag.innerText += " (ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³æˆåŠŸï¼)";
                }
            } else {
                desc.innerText = "ã‚¹ãƒãƒƒãƒˆãƒªã‚¹ãƒˆã«ã¯ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚";
                distTag.innerText = "";
            }
        }

        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371000;
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat / 2)**2 + Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.sin(dLon / 2)**2;
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
        }
    </script>
</body>
</html>
