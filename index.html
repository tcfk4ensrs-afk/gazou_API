<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Spot Explorer</title>
    <style>
        /* å‰å›ã®ã‚¹ã‚¿ã‚¤ãƒªãƒƒã‚·ãƒ¥ãªCSSã‚’ãã®ã¾ã¾ä½¿ç”¨ */
        :root { --primary: #00f2fe; --bg: #0f172a; --glass: rgba(255, 255, 255, 0.1); }
        body { font-family: sans-serif; background: var(--bg); color: white; display: flex; flex-direction: column; align-items: center; margin: 0; padding: 20px; }
        #webcam-container { width: 300px; height: 300px; border-radius: 20px; overflow: hidden; background: #000; position: relative; border: 4px solid var(--primary); }
        video { width: 100%; height: 100%; object-fit: cover; }
        .controls { margin-top: 20px; width: 100%; display: flex; flex-direction: column; align-items: center; gap: 10px; }
        button { padding: 16px 40px; border-radius: 50px; border: none; font-weight: bold; cursor: pointer; width: 80%; max-width: 300px; }
        .btn-capture { background: linear-gradient(to right, #ff416c, #ff4b2b); color: white; }
        .info-card { display: none; width: 85%; max-width: 400px; padding: 20px; background: var(--glass); border-radius: 20px; backdrop-filter: blur(10px); margin-top: 20px; }
        #result-image { width: 100%; border-radius: 10px; margin: 10px 0; }
    </style>
</head>
<body>

    <h1>Spot Explorer AI</h1>
    <div id="status">ã‚·ã‚¹ãƒ†ãƒ ã‚’èµ·å‹•ã—ã¦ãã ã•ã„</div>
    
    <div id="webcam-container">
        <video id="video" autoplay playsinline></video>
        <canvas id="canvas" style="display:none;"></canvas>
    </div>

    <div class="controls">
        <button id="start-btn" onclick="initSystem()" style="background: #007bff; color: white;">ã‚«ãƒ¡ãƒ©ã¨GPSã‚’èµ·å‹•</button>
        <button id="capture-btn" class="btn-capture" style="display:none;" onclick="analyze()">ğŸ“¸ AIåˆ¤å®šã‚’å®Ÿè¡Œ</button>
        <button id="reset-btn" onclick="location.reload()" style="display:none; background: #444; color: white;">ã‚‚ã†ä¸€åº¦</button>
    </div>

    <div id="info-area" class="info-card">
        <h2 id="result-title"></h2>
        <img id="result-image" style="display: none;">
        <p id="result-desc"></p>
        <div id="distance-info" style="color: #00ff88; font-weight: bold;"></div>
    </div>

    <script>
        const TARGETS = {
            "Nintendo": { 
                lat: 35.6586, lon: 139.7454, 
                title: "ä»»å¤©å ‚ã‚¹ãƒãƒƒãƒˆ", 
                desc: "ç‰¹åˆ¥ãªä»»å¤©å ‚æƒ…å ±ã‚’è¡¨ç¤ºä¸­ï¼",
                image: "nintendo.jpg" 
            },
            "ã‚»ãƒ–ãƒ³ã‚¤ãƒ¬ãƒ–ãƒ³": { 
                lat: 35.6812, lon: 139.7671, 
                title: "ã‚»ãƒ–ãƒ³ã‚¤ãƒ¬ãƒ–ãƒ³", 
                desc: "è¿‘éš£åº—èˆ—ã®ã‚¯ãƒ¼ãƒãƒ³ãŒåˆ©ç”¨å¯èƒ½ã§ã™ã€‚",
                image: "711.jpg"
            }
        };

        let userLat, userLon;

        async function initSystem() {
            navigator.geolocation.getCurrentPosition(async (pos) => {
                userLat = pos.coords.latitude;
                userLon = pos.coords.longitude;
                const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
                document.getElementById("video").srcObject = stream;
                document.getElementById("start-btn").style.display = "none";
                document.getElementById("capture-btn").style.display = "block";
                document.getElementById("status").innerText = "åˆ¤å®šå¯¾è±¡ã‚’æ˜ ã—ã¦ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„";
            });
        }

        async function analyze() {
            document.getElementById("status").innerText = "AIè§£æä¸­...";
            document.getElementById("capture-btn").style.display = "none";

            const video = document.getElementById("video");
            const canvas = document.getElementById("canvas");
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            canvas.getContext("2d").drawImage(video, 0, 0);
            const base64Image = canvas.toDataURL("image/jpeg").split(",")[1];

            try {
                // Netlifyã®ã‚µãƒ¼ãƒãƒ¼ãƒ¬ã‚¹é–¢æ•°ã‚’å‘¼ã³å‡ºã™
                const response = await fetch('/.netlify/functions/analyze', {
                    method: 'POST',
                    body: JSON.stringify({
                        image: base64Image,
                        prompt: "ã“ã®ç”»åƒã«Nintendoã‹ã‚»ãƒ–ãƒ³ã‚¤ãƒ¬ãƒ–ãƒ³ã®çœ‹æ¿ãŒã‚ã‚‹ã‹åˆ¤å®šã—ã¦ã€‚ã‚ã‚Œã°ãã®åå‰ã ã‘è¿”ã—ã¦ã€‚ãªã‘ã‚Œã°Noneã¨è¿”ã—ã¦ã€‚"
                    })
                });

                const data = await response.json();
                const resultText = data.candidates[0].content.parts[0].text.trim();

                if (resultText !== "None" && TARGETS[resultText]) {
                    const target = TARGETS[resultText];
                    const dist = calculateDistance(userLat, userLon, target.lat, target.lon);

                    if (dist <= 50) {
                        showResult(target, dist);
                        document.getElementById("status").innerText = "æˆåŠŸï¼æƒ…å ±ã‚’è¡¨ç¤ºã—ã¾ã™ã€‚";
                    } else {
                        document.getElementById("status").innerText = `å¯¾è±¡ã¯ ${resultText} ã§ã™ãŒã€${Math.round(dist)}mé›¢ã‚Œã¦ã„ã¾ã™ã€‚`;
                    }
                } else {
                    document.getElementById("status").innerText = "å¯¾è±¡ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚";
                }
                document.getElementById("reset-btn").style.display = "block";
            } catch (e) {
                document.getElementById("status").innerText = "é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚";
            }
        }

        function showResult(target, dist) {
            document.getElementById("info-area").style.display = "block";
            document.getElementById("result-title").innerText = target.title;
            document.getElementById("result-desc").innerText = target.desc;
            document.getElementById("distance-info").innerText = `ğŸ“ è·é›¢: ${Math.round(dist)}m`;
            if (target.image) {
                const img = document.getElementById("result-image");
                img.src = target.image;
                img.style.display = "block";
            }
        }

        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371000;
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat / 2)**2 + Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.sin(dLon / 2)**2;
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
        }
    </script>
</body>
</html>
